{% extends "base.html" %}

{% block title %}Dashboard - UCMS{% endblock %}

{% block content %}
<div id="status-message-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 my-4">
</div>
<!-- Popup Modal -->
<div id="enroll-popup-overlay"
    class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div id="enroll-popup" class="bg-white rounded-lg shadow-lg max-w-md w-full p-6">
        <h3 id="enroll-popup-title" class="text-lg font-semibold mb-2 text-red-600">
            Error
        </h3>
        <p id="enroll-popup-message" class="text-sm text-gray-700 mb-4">
            <!-- message goes here -->
        </p>
        <div class="text-right">
            <button type="button" class="btn-secondary px-4 py-2" onclick="closeEnrollPopup()">
                Close
            </button>
        </div>
    </div>
</div>

<div class="max-w-7xl flex-grow mx-auto" id="dashboard-content">
    <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-900 mb-2">Student Dashboard</h2>
        <p class="text-xl text-blue-600" id="welcome-message">Welcome back, loading...</p>
    </div>

    <!-- === Student Metrics Cards === -->
    <div class="grid md:grid-cols-3 gap-6 mb-6">

        <!-- Current GPA (still hardcoded or later dynamic) -->
        <div class="card p-8 text-center">
            <p class="text-sm text-gray-600">Current GPA</p>
            <p class="text-3xl font-bold text-gray-900" id="metric-gpa">3.85</p>
        </div>

        <!-- Enrolled Courses -->
        <div class="card p-8 text-center">
            <p class="text-sm text-gray-600">Current Enrollments</p>
            <p class="text-3xl font-bold text-gray-900" id="metric-enrolled-count">5</p>
        </div>

        <!-- Completed Courses -->
        <div class="card p-8 text-center">
            <p class="text-sm text-gray-600">Completed Modules</p>
            <p class="text-3xl font-bold text-gray-900" id="metric-completed-count">7</p>
        </div>

    </div>
    <!-- === End Metrics Cards === -->

    <div id="student-info-section" class="grid md:grid-cols-2 gap-6 mb-8">
        <!-- Left: Enrolled -->
        <div class="card bg-yellow-50">
            <h3 class="text-xl font-semibold m-3">Current Enrollments</h3>
            <div id="enrolled-list" class="space-y-2 text-sm">Loading...</div>
        </div>

        <!-- Right: Completed -->
        <div class="card bg-green-50">
            <h3 class="text-xl font-semibold m-3">Completed Modules</h3>
            <div id="completed-list" class="space-y-2 text-sm">Loading...</div>
        </div>
    </div>

    <div class="card mb-8">
        <h3 class="text-xl font-semibold m-3 ">Search Modules</h3>
        <form id="module-search-form" class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
            <input type="text" id="search-query" placeholder="e.g., Core classes, Alan Turing, CS101"
                class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500"
                required>
            <button type="submit" class="btn-primary flex-shrink-0 p-3">Search</button>
        </form>
    </div>

    <div id="scroll-to-view" class="card">
        <h3 class="text-2xl font-semibold mb-4 border-b pb-2">Available Modules</h3>
        <div id="module-results-list" class="divide-y divide-gray-200">
            <p class="text-center text-gray-500 p-6">Use the search bar above to find modules, or click "Show All" to
                browse.</p>
            <button class="btn-secondary w-full mt-4" onclick="handleShowAllModules()">Show All Modules</button>
        </div>
    </div>
</div>

<script>
    // --- 1. POPUP HELPERS ---
    function showEnrollPopup(message, type = 'error') {
        const overlay = document.getElementById('enroll-popup-overlay');
        const titleEl = document.getElementById('enroll-popup-title');
        const msgEl = document.getElementById('enroll-popup-message');
        if (!overlay || !titleEl || !msgEl) { alert(message); return; }
        msgEl.textContent = message || '';
        if (type === 'success') {
            titleEl.textContent = 'Success';
            titleEl.className = 'text-lg font-bold text-green-600 mb-2';
        } else {
            titleEl.textContent = 'Error';
            titleEl.className = 'text-lg font-bold text-red-600 mb-2';
        }
        overlay.classList.remove('hidden');
    }

    function closeEnrollPopup() {
        const overlay = document.getElementById('enroll-popup-overlay');
        if (overlay) overlay.classList.add('hidden');
    }

    // --- 2. GLOBAL DATA ---
    let allStudentEnrollments = [];
    let studentMajorId = null; // <--- NEW: Store the dynamic major here

    // --- 3. INIT ---
    document.addEventListener('DOMContentLoaded', async () => { // Made async
        if (!currentState.loggedIn) { return; }
        document.getElementById('welcome-message').textContent = 
            `Welcome back, ${currentState.userName} (ID: ${currentState.studentId})`;
        
        // 1. Fetch Student Details (To get Major ID)
        await loadStudentProfile(); 

        // 2. Load Enrollments & Search
        loadStudentEnrollments();
        document.getElementById('module-search-form').addEventListener('submit', handleModuleSearch);
        handleShowAllModules();
    });

    // --- NEW: Fetch Major ID from Database ---
    async function loadStudentProfile() {
        try {
            const data = await apiFetch(`/api/students/${currentState.studentId}`);
            if (data && data.major_id) {
                studentMajorId = data.major_id; // e.g., 'SE'
                console.log("Student Major loaded:", studentMajorId);
            }
        } catch (error) {
            console.error("Failed to load student profile:", error);
        }
    }

    // --- 4. LOAD DATA ---
    async function loadStudentEnrollments() {
        const enrolledList = document.getElementById('enrolled-list');
        const completedList = document.getElementById('completed-list');
        try {
            allStudentEnrollments = await apiFetch(`/api/student/${currentState.studentId}/enrollments`);
            if (!allStudentEnrollments) allStudentEnrollments = [];

            const enrolledModules = allStudentEnrollments.filter(c => c.status === 'Enrolled');
            const completedModules = allStudentEnrollments.filter(c => c.status === 'Completed');

            const em = document.getElementById('metric-enrolled-count');
            const cm = document.getElementById('metric-completed-count');
            if(em) em.textContent = enrolledModules.length;
            if(cm) cm.textContent = completedModules.length;

            const renderList = (items, listEl, emptyMsg, isEnrolled) => {
                if (items.length === 0) {
                    listEl.innerHTML = `<p class="text-gray-500 mx-3">${emptyMsg}</p>`;
                } else {
                    listEl.innerHTML = items.map(module => `
                    <div class="p-3 border ${isEnrolled ? 'border-yellow-200 bg-yellow-50' : 'border-green-200 bg-green-50'} rounded-md flex items-center justify-between gap-3 shadow-sm">
                        <div>
                            <strong class="${isEnrolled ? 'text-blue-800' : 'text-green-800'} block">
                                ${module.module_id} - ${module.module_name || module.title}
                            </strong>
                            <span class="text-sm text-gray-600 block">
                                Taught by: ${module.instructor_name} (${module.credits} Credits)
                            </span>
                            <span class="text-xs font-semibold text-gray-700 bg-gray-200 px-2 py-1 rounded-full mt-1 inline-block">
                                ${module.academic_term}
                            </span>
                        </div>
                        ${isEnrolled ? `
                        <button class="inline-flex items-center px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-semibold border border-red-200 hover:bg-red-200 hover:text-red-800 transition"
                            onclick="handleDropEnrollment('${module.module_id}')">Drop</button>
                        ` : `
                        <div class="text-right">
                            <span class="text-xs text-gray-500 block mb-1">Grade</span>
                            <span class="inline-block px-3 py-1 rounded-full bg-green-200 font-bold text-green-800 text-sm">${module.final_grade ?? 'N/A'}</span>
                        </div>
                        `}
                    </div>`).join('');
                }
            };
            renderList(enrolledModules, enrolledList, "You have no current enrollments.", true);
            renderList(completedModules, completedList, "You have no completed modules yet.", false);
        } catch (error) { console.error("Error loading enrollments:", error); }
    }

    // --- 5. ACTIONS ---
    async function handleEnroll(moduleId) {
        try {
            const data = await apiFetch('/api/enroll', {
                method: 'POST',
                body: { student_id: currentState.studentId, module_id: moduleId }
            });
            if (data && data.message) {
                showEnrollPopup(data.message, 'success');
                loadStudentEnrollments();
                handleShowAllModules();
                console.log(data);
            }
        } catch (error) { showEnrollPopup(error.message, 'error'); }
    }

    async function handleDropEnrollment(moduleId) {
        if (!confirm(`Drop module ${moduleId}?`)) return;
        try {
            const data = await apiFetch('/api/enroll/drop', {
                method: 'POST',
                body: { student_id: currentState.studentId, module_id: moduleId }
            });
            if (data && data.message) {
                showEnrollPopup(data.message, 'success');
                loadStudentEnrollments();
                handleShowAllModules();
            }
        } catch (error) { showEnrollPopup(error.message, 'error'); }
    }

    async function handleShowAllModules() {
        try {
            // We append the major query here too if we want the default list to be filtered
            let endpoint = '/api/modules';
            // NOTE: Your current /api/modules endpoint retrieves EVERYTHING from SQL.
            // If you want the default view filtered, you'd need to update that API endpoint too.
            // For now, we will rely on search to filter.
            
            const results = await apiFetch(endpoint);
            if (results) displayModuleResults(results);
        } catch (e) { console.error(e); }
    }

    // --- 6. SMART SEARCH LOGIC (DYNAMIC MAJOR) ---
    async function handleModuleSearch(event) {
        event.preventDefault();
        const query = document.getElementById('search-query').value.toLowerCase();

        // 1. LOCAL Search
        const localKeywords = ['my', 'enrolled', 'completed', 'schedule'];
        if (localKeywords.some(kw => query.includes(kw))) {
            let localQuery = query.replace(/my|modules|in|enrolled|completed|schedule|of/g, '').trim();
            localQuery = localQuery.replace(/\s/g, ''); 
            const results = allStudentEnrollments.filter(c => {
                const corpus = `${c.module_name.toLowerCase()} ${c.module_id.toLowerCase()} ${c.academic_term.toLowerCase()}`;
                return corpus.includes(localQuery);
            });
            displayModuleResults(results, true);
            return;
        }

        // 2. GLOBAL Search
        let semanticQuery = query;
        let params = new URLSearchParams();

        // --- DYNAMIC MAJOR FILTER ---
        if (studentMajorId) {
            params.set('major', studentMajorId); // Uses the value loaded from DB (e.g. 'SE')
        }
        // ----------------------------

        let targetYear = null;
        let targetTri = null;

        if (query.match(/y(ear)?\s?1/) || query.includes('first year') || query.includes('1000')) targetYear = 1;
        else if (query.match(/y(ear)?\s?2/) || query.includes('second year') || query.includes('2000')) targetYear = 2;
        else if (query.match(/y(ear)?\s?3/) || query.includes('third year') || query.includes('3000')) targetYear = 3;
        else if (query.match(/y(ear)?\s?4/) || query.includes('fourth year') || query.includes('4000')) targetYear = 4;

        if (query.match(/t(ri)?\s?1/) || query.includes('fall') || query.includes('sep')) targetTri = 1;
        else if (query.match(/t(ri)?\s?2/) || query.includes('spring') || query.includes('jan')) targetTri = 2;
        else if (query.match(/t(ri)?\s?3/) || query.includes('summer') || query.includes('may')) targetTri = 3;

        if (targetYear && targetTri) {
            const termCode = `Y${targetYear}T${targetTri}`;
            params.set('term', termCode);
            semanticQuery = semanticQuery.replace(/y(ear)?\s?\d/g, '').replace(/t(ri)?\s?\d/g, '').replace(/fall|spring|summer/g, '');
        } else if (targetYear) {
            params.set('level', targetYear * 1000);
            semanticQuery = semanticQuery.replace(/y(ear)?\s?\d/g, '');
        }

        semanticQuery = semanticQuery.replace(/modules|module|in|by|for|of|classes/g, '').trim();
        params.set('q', semanticQuery || 'all'); 

        try {
            const results = await apiFetch(`/api/search?${params.toString()}`);
            if (results) displayModuleResults(results, false);
        } catch (e) {
            showEnrollPopup(`Search failed: ${e.message}`, 'error');
        }
        
        const el = document.getElementById('scroll-to-view');
        if(el) el.scrollIntoView({ behavior: 'smooth' });
    }

    function displayModuleResults(modules, isLocalSearch = false) {
        const resultsList = document.getElementById('module-results-list');
        if (!resultsList) return;

        if (modules.length === 0) {
            resultsList.innerHTML = `<p class="text-center text-red-500 p-6">No modules matched your query.</p>`;
            resultsList.innerHTML += `<button class="btn-secondary w-full mt-4 py-2" onclick="handleShowAllCourses()">Show All Modules</button>`;
            return;
        }

        const enrollmentStatusById = {};
        allStudentEnrollments.forEach(c => { if(c.module_id) enrollmentStatusById[c.module_id] = c.status; });

        const sortedModules = [...modules].sort((a, b) => {
            const aEnrolled = !!enrollmentStatusById[a.module_id];
            const bEnrolled = !!enrollmentStatusById[b.module_id];
            return (aEnrolled === bEnrolled) ? 0 : (aEnrolled ? 1 : -1);
        });

        resultsList.innerHTML = sortedModules.map(module => {
            const moduleId = module.module_id;
            const moduleCode = module.module_code || moduleId;
            const moduleName = module.module_name || module.title;
            const description = module.description || 'No description available.';
            const prereqs = module.prerequisites || 'N/A';
            const instructor = module.instructor_name || 'N/A';
            const slotsLeft = module.slots_left ?? 'N/A';
            const maxCap = module.max_capacity || 'N/A';

            const status = enrollmentStatusById[moduleId];
            const isAlreadyEnrolled = !!status;

            let btn = '';
            if (isLocalSearch) {
                const localStatus = module.status || 'Completed';
                const colorClass = (localStatus === 'Enrolled') ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700';
                btn = `<button class="btn-secondary ${colorClass} cursor-not-allowed" disabled>${localStatus}</button>`;
            } else {
                if (isAlreadyEnrolled) {
                    btn = `<button class="btn-secondary bg-gray-200 text-gray-500 cursor-not-allowed" disabled>${status}</button>`;
                } else {
                    const isFull = slotsLeft === 0;
                    btn = isFull 
                        ? `<button class="btn-secondary bg-red-100 text-red-700 cursor-not-allowed" disabled>Full</button>`
                        : `<button class="btn-primary p-3" onclick="handleEnroll('${moduleId}')">Apply</button>`;
                }
            }

            const rowOpacity = isAlreadyEnrolled ? 'opacity-60 bg-gray-50' : 'bg-white';

            return `
                <div class="course-item flex justify-between items-center flex-wrap p-4 hover:bg-gray-50 transition ${rowOpacity}">
                    <div class="flex-grow min-w-0 pr-4">
                        <h4 class="text-lg font-bold text-blue-800">${moduleName} (${moduleCode})</h4>
                        <p class="text-sm text-gray-700 mt-1">${description}</p>
                        <div class="flex gap-2 mt-2">
                            <span class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded">${module.academic_term}</span>
                            <span class="text-xs text-gray-500 px-2 py-1">Prereqs: ${prereqs}</span>
                        </div>
                    </div>
                    <div class="text-right space-y-1 mt-2 sm:mt-0 min-w-[140px]">
                        <p class="text-sm font-semibold text-gray-800">Taught by: ${instructor}</p>
                        <p class="text-sm ${slotsLeft === 0 ? 'text-red-600 font-bold' : 'text-green-600'}">
                            ${slotsLeft} / ${maxCap} Slots
                        </p>
                        <div class="mt-2">${btn}</div>
                    </div>
                </div>
            `;
        }).join('');

        resultsList.innerHTML += `<button class="btn-secondary w-full mt-4 py-2" onclick="handleShowAllCourses()">Show All Modules</button>`;
    }
</script>
{% endblock %}