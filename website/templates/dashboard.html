{% extends "base.html" %}

{% block title %}Dashboard - UCMS{% endblock %}

{% block content %}
<div id="status-message-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 my-4">
</div>
<div id="enroll-popup-overlay"
    class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div id="enroll-popup" class="bg-white rounded-lg shadow-lg max-w-md w-full p-6">
        <h3 id="enroll-popup-title" class="text-lg font-semibold mb-2 text-red-600">
            Error
        </h3>
        <p id="enroll-popup-message" class="text-sm text-gray-700 mb-4">
            </p>
        <div class="text-right">
            <button type="button" class="btn-secondary px-4 py-2" onclick="closeEnrollPopup()">
                Close
            </button>
        </div>
    </div>
</div>

<div class="max-w-7xl flex-grow mx-auto" id="dashboard-content">
    <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-900 mb-2">Student Dashboard</h2>
        <p class="text-xl text-blue-600" id="welcome-message">Welcome back, loading...</p>
    </div>

    <div class="grid md:grid-cols-3 gap-6 mb-6">
        <div class="card p-8 text-center">
            <p class="text-sm text-gray-600">Current GPA</p>
            <p class="text-3xl font-bold text-gray-900" id="metric-gpa">3.85</p>
        </div>
        <div class="card p-8 text-center">
            <p class="text-sm text-gray-600">Current Enrollments</p>
            <p class="text-3xl font-bold text-gray-900" id="metric-enrolled-count">0</p>
        </div>
        <div class="card p-8 text-center">
            <p class="text-sm text-gray-600">Completed Modules</p>
            <p class="text-3xl font-bold text-gray-900" id="metric-completed-count">7</p>
        </div>
    </div>

    <div id="student-info-section" class="grid md:grid-cols-2 gap-6 mb-8">
        <div class="card bg-yellow-50">
            <h3 class="text-xl font-semibold m-3">Current Enrollments</h3>
            <div id="enrolled-list" class="space-y-2 text-sm">Loading...</div>
        </div>

        <!-- Right: Completed -->
        <div class="card bg-green-50">
            <h3 class="text-xl font-semibold m-3">Completed Modules</h3>
            <div id="completed-list" class="space-y-2 text-sm">Loading...</div>
        </div>
    </div>

    <div class="card mb-8">
        <h3 class="text-xl font-semibold m-3 ">Search Modules</h3>
        <form id="module-search-form" class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
            <input type="text" id="search-query" placeholder="e.g., Core classes, Alan Turing, CS101"
                class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                required>
            <button type="submit" class="btn-primary flex-shrink-0 p-3">Search</button>
        </form>
    </div>

    <div id="pagination-controls" class="mt-3 mb-3 flex justify-center items-center space-x-2 flex-wrap gap-y-2 hidden">
    </div>

    <div id="scroll-to-view" class="card">
        <h3 class="text-2xl font-semibold mb-4 border-b pb-2">Available Modules</h3>
        <div id="module-results-list" class="divide-y divide-gray-200">
            <p class="text-center text-gray-500 p-6">Use the search bar above to find modules, or click "Show All" to
                browse.</p>
            <button class="btn-secondary w-full mt-4" onclick="handleShowAllModules()">Show All Modules</button>
        </div>
    </div>
</div>

<script>
    // --- 1. POPUP HELPERS ---
    function showEnrollPopup(message, type = 'error') {
        const overlay = document.getElementById('enroll-popup-overlay');
        const titleEl = document.getElementById('enroll-popup-title');
        const msgEl = document.getElementById('enroll-popup-message');
        if (!overlay || !titleEl || !msgEl) { alert(message); return; }
        msgEl.textContent = message || '';
        if (type === 'success') {
            titleEl.textContent = 'Success';
            titleEl.className = 'text-lg font-bold text-green-600 mb-2';
        } else {
            titleEl.textContent = 'Error';
            titleEl.className = 'text-lg font-bold text-red-600 mb-2';
        }
        overlay.classList.remove('hidden');
    }

    function closeEnrollPopup() {
        const overlay = document.getElementById('enroll-popup-overlay');
        if (overlay) overlay.classList.add('hidden');
    }

    // --- 2. GLOBAL DATA ---
    let allStudentEnrollments = [];
    let studentMajorId = null; 
    
    // --- PAGINATION STATE ---
    let currentSearchResults = []; 
    let currentPage = 1;
    const itemsPerPage = 5;
    let isCurrentSearchLocal = false; 

    // --- 3. INIT ---
    document.addEventListener('DOMContentLoaded', async () => {
        if (!currentState.loggedIn) { return; }
        document.getElementById('welcome-message').textContent = 
            `Welcome back, ${currentState.userName} (ID: ${currentState.studentId})`;
        
        await loadStudentProfile(); 
        await loadStudentEnrollments();
        document.getElementById('module-search-form').addEventListener('submit', handleModuleSearch);
        handleShowAllModules();
    });

    async function loadStudentProfile() {
        try {
            const data = await apiFetch(`/api/students/${currentState.studentId}`);
            if (data && data.major_id) studentMajorId = data.major_id; 
        } catch (e) { console.error(e); }
    }

    async function loadStudentEnrollments() {
        const enrolledList = document.getElementById('enrolled-list');
        const completedList = document.getElementById('completed-list');
        try {
            allStudentEnrollments = await apiFetch(`/api/student/${currentState.studentId}/enrollments`);
            if (!allStudentEnrollments) allStudentEnrollments = [];

            const enrolledModules = allStudentEnrollments.filter(c => c.status === 'Enrolled');
            const completedModules = allStudentEnrollments.filter(c => c.status === 'Completed');

            const em = document.getElementById('metric-enrolled-count');
            const cm = document.getElementById('metric-completed-count');
            if(em) em.textContent = enrolledModules.length;
            if(cm) cm.textContent = completedModules.length;

            const renderList = (items, listEl, emptyMsg, isEnrolled) => {
                if (items.length === 0) {
                    listEl.innerHTML = `<p class="text-gray-500 mx-3">${emptyMsg}</p>`;
                } else {
                    listEl.innerHTML = items.map(module => `
                    <div class="p-3 border ${isEnrolled ? 'border-yellow-200 bg-yellow-50' : 'border-green-200 bg-green-50'} rounded-md flex items-center justify-between gap-3 shadow-sm">
                        <div>
                            <strong class="${isEnrolled ? 'text-blue-800' : 'text-green-800'} block">
                                ${module.module_id} - ${module.module_name || module.title}
                            </strong>
                            <span class="text-sm text-gray-600 block">
                                Taught by: ${module.instructor_name} (${module.credits} Credits)
                            </span>
                            <span class="text-xs font-semibold text-gray-700 bg-gray-200 px-2 py-1 rounded-full mt-1 inline-block">
                                ${module.academic_term}
                            </span>
                        </div>
                        ${isEnrolled ? `
                        <button class="inline-flex items-center px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-semibold border border-red-200 hover:bg-red-200 hover:text-red-800 transition"
                            onclick="handleDropEnrollment('${module.module_id}')">Drop</button>
                        ` : `
                        <div class="text-right">
                            <span class="text-xs text-gray-500 block mb-1">Grade</span>
                            <span class="inline-block px-3 py-1 rounded-full bg-green-200 font-bold text-green-800 text-sm">${module.final_grade ?? 'N/A'}</span>
                        </div>
                        `}
                    </div>`).join('');
                }
            };
            renderList(enrolledModules, enrolledList, "You have no current enrollments.", true);
            renderList(completedModules, completedList, "You have no completed modules yet.", false);
        } catch (error) { console.error("Error loading enrollments:", error); }
    }

    // --- 5. ACTIONS ---
    async function handleEnroll(moduleId) {
        try {
            const data = await apiFetch('/api/enroll', {
                method: 'POST',
                body: { student_id: currentState.studentId, module_id: moduleId }
            });
            if (data && data.message) {
                showEnrollPopup(data.message, 'success');
                await loadStudentEnrollments();
                await handleShowAllModules(); 
            }
        } catch (error) { showEnrollPopup(error.message, 'error'); }
    }

    async function handleDropEnrollment(moduleId) {
        if (!confirm(`Drop module ${moduleId}?`)) return;
        try {
            const data = await apiFetch('/api/enroll/drop', {
                method: 'POST',
                body: { student_id: currentState.studentId, module_id: moduleId }
            });
            if (data && data.message) {
                showEnrollPopup(data.message, 'success');
                loadStudentEnrollments();
                handleShowAllModules();
            }
        } catch (error) { showEnrollPopup(error.message, 'error'); }
    }

    async function handleShowAllModules() {
        try {
            const results = await apiFetch('/api/modules');
            if (results) displayModuleResults(results);
        } catch (e) { console.error(e); }
    }

    // --- 6. SMART NORMALIZER & SEARCH ---
    function extractFilters(query) {
        let targetYear = null;
        let targetTri = null;

        // 1. Pre-process: Normalize to lowercase
        let processed = query.toLowerCase();

        // 2. Helper: Convert Words to Numbers
        // Includes "Final Year" common in SIT context
        const wordMap = {
            'one': '1', 'two': '2', 'three': '3', 'four': '4',
            'first': '1', 'second': '2', 'third': '3', 'fourth': '4',
            'freshman': '1', 'freshie': '1', // SIT Slang
            'sophomore': '2',
            'junior': '3',
            'senior': '4', 'final year': '4'
        };

        // Replace number words with digits safely (word boundary check)
        for (const [word, num] of Object.entries(wordMap)) {
            processed = processed.replace(new RegExp(`\\b${word}\\b`, 'g'), num);
        }

        // 3. SIT Academic Calendar Mapping (Months/Seasons -> Trimesters)
        // T1: Sep-Dec | T2: Jan-Apr | T3: May-Aug
        const triMap = {
            't1': ['fall', 'sep', 'september', 'oct', 'october', 'nov', 'november', 'dec', 'december'],
            't2': ['spring', 'jan', 'january', 'feb', 'february', 'mar', 'march', 'apr', 'april'],
            't3': ['summer', 'may', 'jun', 'june', 'jul', 'july', 'aug', 'august']
        };

        for (const [tri, keywords] of Object.entries(triMap)) {
            const pattern = new RegExp(`\\b(${keywords.join('|')})\\b`, 'g');
            processed = processed.replace(pattern, tri); // Replace months with 't1', 't2', 't3'
        }

        // 4. Regex Patterns for Year/Tri Extraction

        // Pattern A: Tight codes (e.g., "y1t1", "y3t2")
        const tightCodeRegex = /\by(\d)t(\d)\b/;

        // Pattern B: Verbose "Year X Trimester Y" (handles "Sem", "Tri", "Term")
        const yearFirstRegex = /\by(?:ear|r)?\s*(\d)\s*(?:trimester|tri|term|sem|semester|t)\s*(\d)\b/;
        
        const triFirstRegex = /\b(?:trimester|tri|term|sem|semester|t)\s*(\d)\s*y(?:ear|r)?\s*(\d)\b/;
        const yearOnlyRegex = /\by(?:ear|r)?\s*(\d)\b/;
        const triOnlyRegex = /\b(?:trimester|tri|term|sem|semester|t)\s*(\d)\b/;
        const levelRegex = /\b(\d)000\b/;


        let match;

        if ((match = processed.match(tightCodeRegex))) {
            targetYear = parseInt(match[1]);
            targetTri = parseInt(match[2]);
        }
        else if ((match = processed.match(yearFirstRegex))) {
            targetYear = parseInt(match[1]);
            targetTri = parseInt(match[2]);
        }
        else if ((match = processed.match(triFirstRegex))) {
            targetTri = parseInt(match[1]);
            targetYear = parseInt(match[2]);
        }
        else {
            // Look for independent Year/Tri
            const yMatch = processed.match(yearOnlyRegex);
            const tMatch = processed.match(triOnlyRegex);
            const lMatch = processed.match(levelRegex);

            if (yMatch) targetYear = parseInt(yMatch[1]);
            if (tMatch) targetTri = parseInt(tMatch[1]);

            // Fallback: If no year found, check for "1000/2000" syntax
            if (!targetYear && lMatch) {
                targetYear = parseInt(lMatch[1]);
            }
        }

        // 6. Cleanup Query
        // Remove the detected constraints so the search string is clean
        let cleanedQuery = query; // Start with original query to preserve casing of other words

        // Helper to remove patterns case-insensitively
        const removePattern = (regex) => {
            cleanedQuery = cleanedQuery.replace(new RegExp(regex, 'gi'), '');
        };

        // Remove specific patterns found in Step 4
        removePattern(/y(\d)t(\d)/); // y1t1
        removePattern(/y(ear|r)?\s*(\d|one|two|three|four|first|second|third|fourth)/); // Year X
        removePattern(/(trimester|tri|term|sem|semester|t)\s*(\d|one|two|three)/); // Tri X
        removePattern(/\b(fall|spring|summer|sep|september|jan|january|may)\b/); // Seasons/Months

        // Remove filler words common in student queries
        const fillerWords = [
            'my', 'courses', 'course', 'modules', 'module', 'mod',
            'classes', 'class', 'in', 'by', 'for', 'of',
            'schedule', 'enrolled', 'completed', 'taking', 'plan'
        ];
        removePattern(`\\b(${fillerWords.join('|')})\\b`);

        // Final trim
        cleanedQuery = cleanedQuery.replace(/\s+/g, ' ').trim();

        return { targetYear, targetTri, cleanedQuery };
    }
    
    async function handleModuleSearch(event) {
        event.preventDefault();
        const rawQuery = document.getElementById('search-query').value;
        const { targetYear, targetTri, cleanedQuery } = extractFilters(rawQuery);
        
        let termCode = null;
        if (targetYear && targetTri) {
            termCode = `Y${targetYear}T${targetTri}`; 
        }

        // LOCAL SEARCH
        const lowerQuery = rawQuery.toLowerCase();
        const localKeywords = ['my', 'enrolled', 'completed', 'schedule'];
        const isLocalSearch = localKeywords.some(kw => lowerQuery.includes(kw));

        if (isLocalSearch) {
            const results = allStudentEnrollments.filter(c => {
                if (termCode) {
                    if (!c.academic_term || !c.academic_term.toUpperCase().includes(termCode)) return false;
                } 
                else if (targetYear) {
                    const levelDigit = c.module_id.match(/\d/); 
                    if (levelDigit && parseInt(levelDigit[0]) !== targetYear) return false;
                }
                if (cleanedQuery.length > 0) {
                    const corpus = `${c.module_name.toLowerCase()} ${c.module_id.toLowerCase()}`;
                    return corpus.includes(cleanedQuery.toLowerCase());
                }
                return true;
            });
            displayModuleResults(results, true);
            return;
        }

        // GLOBAL SEARCH
        let params = new URLSearchParams();
        if (studentMajorId) params.set('major', studentMajorId);

        if (termCode) {
            params.set('term', termCode); 
        } else if (targetYear) {
            params.set('level', targetYear * 1000);
        }

        params.set('q', cleanedQuery || 'all'); 

        try {
            const results = await apiFetch(`/api/search?${params.toString()}`);
            if (results) displayModuleResults(results, false);
        } catch (e) {
            showEnrollPopup(`Search failed: ${e.message}`, 'error');
        }
        
        const el = document.getElementById('scroll-to-view');
        if(el) el.scrollIntoView({ behavior: 'smooth' });
    }

    // --- 7. ADVANCED PAGINATION & RENDERING ---

    function displayModuleResults(modules, isLocal = false) {
        const resultsList = document.getElementById('module-results-list');
        if (!resultsList) return;

        if (modules.length === 0) {
            resultsList.innerHTML = `<p class="text-center text-red-500 p-6">No modules matched your query.</p>`;
            resultsList.innerHTML += `<button class="btn-secondary w-full mt-4 py-2" onclick="handleShowAllModules()">Show All Modules</button>`;
            document.getElementById('pagination-controls').classList.add('hidden');
            return;
        }

        const enrollmentStatusById = {};
        allStudentEnrollments.forEach(c => { if(c.module_id) enrollmentStatusById[c.module_id] = c.status; });

        // Sort: Available first
        const sortedModules = [...modules].sort((a, b) => {
            const aEnrolled = !!enrollmentStatusById[a.module_id];
            const bEnrolled = !!enrollmentStatusById[b.module_id];
            if (aEnrolled === bEnrolled) return 0;
            return aEnrolled ? 1 : -1;
        });

        // Update State
        currentSearchResults = sortedModules;
        isCurrentSearchLocal = isLocal;
        currentPage = 1; 

        renderPage();
        renderPaginationControls();
    }

    function renderPage() {
        const resultsList = document.getElementById('module-results-list');
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedItems = currentSearchResults.slice(startIndex, endIndex);

        const enrollmentStatusById = {};
        allStudentEnrollments.forEach(c => { if(c.module_id) enrollmentStatusById[c.module_id] = c.status; });

        const listContent = paginatedItems.map(module => {
            const moduleId = module.module_id;
            const moduleCode = module.module_id || moduleId;
            const moduleName = module.module_name || module.title;
            const description = module.description || 'No description available.';
            const prereqs = module.prerequisites || 'N/A';
            const instructor = module.instructor_name || 'N/A';
            const slotsLeft = module.slots_left ?? 'N/A';
            const maxCap = module.max_capacity || 'N/A';

            const status = enrollmentStatusById[moduleId];
            const isAlreadyEnrolled = !!status;

            let btn = '';
            if (isCurrentSearchLocal) {
                const localStatus = module.status || 'Completed';
                const colorClass = (localStatus === 'Enrolled') ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700';
                btn = `<button class="btn-secondary ${colorClass} cursor-not-allowed" disabled>${localStatus}</button>`;
            } else {
                if (isAlreadyEnrolled) {
                    btn = `<button class="btn-secondary bg-gray-200 text-gray-500 cursor-not-allowed" disabled>${status}</button>`;
                } else {
                    const isFull = slotsLeft === 0;
                    btn = isFull 
                        ? `<button class="btn-secondary bg-red-100 text-red-700 cursor-not-allowed" disabled>Full</button>`
                        : `<button class="btn-primary p-3" onclick="handleEnroll('${moduleId}')">Apply</button>`;
                }
            }

            const rowOpacity = isAlreadyEnrolled ? 'opacity-60 bg-gray-50' : 'bg-white';

            return `
                <div class="course-item flex justify-between items-center flex-wrap p-4 hover:bg-gray-50 transition ${rowOpacity}">
                    <div class="flex-grow min-w-0 pr-4">
                        <h4 class="text-lg font-bold text-blue-800">${moduleName} (${moduleCode})</h4>
                        <p class="text-sm text-gray-700 mt-1">${description}</p>
                        <div class="flex gap-2 mt-2">
                            <span class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded">${module.academic_term}</span>
                            <span class="text-xs text-gray-500 px-2 py-1">Prereqs: ${prereqs}</span>
                        </div>
                    </div>
                    <div class="text-right space-y-1 mt-2 sm:mt-0 min-w-[140px]">
                        <p class="text-sm font-semibold text-gray-800">Taught by: ${instructor}</p>
                        <p class="text-sm ${slotsLeft === 0 ? 'text-red-600 font-bold' : 'text-green-600'}">
                            ${slotsLeft} / ${maxCap} Slots
                        </p>
                        <div class="mt-2">${btn}</div>
                    </div>
                </div>
            `;
        }).join('');
        
        resultsList.innerHTML = listContent;
    }

    function renderPaginationControls() {
        const paginationContainer = document.getElementById('pagination-controls');
        const totalPages = Math.ceil(currentSearchResults.length / itemsPerPage);

        if (totalPages <= 1) {
            paginationContainer.classList.add('hidden');
            return;
        } else {
            paginationContainer.classList.remove('hidden');
        }

        let paginationHTML = '';

        // Prev Button
        paginationHTML += `
            <button 
                onclick="changePage(${currentPage - 1})" 
                class="px-3 py-1 border rounded-md ${currentPage === 1 ? 'text-gray-400 cursor-not-allowed bg-gray-50' : 'text-blue-600 hover:bg-blue-50 bg-white'}"
                ${currentPage === 1 ? 'disabled' : ''}>
                &laquo;
            </button>
        `;

        // --- Advanced Pagination Logic (Neighbors + Ellipsis) ---
        const generatePageButton = (page) => `
            <button 
                onclick="changePage(${page})" 
                class="px-3 py-1 border rounded-md ${page === currentPage ? 'bg-blue-600 text-white border-blue-600' : 'text-gray-700 hover:bg-gray-100 bg-white'}">
                ${page}
            </button>
        `;
        const generateEllipsis = () => `<span class="px-2 text-gray-400">...</span>`;

        if (totalPages <= 7) {
            for (let i = 1; i <= totalPages; i++) paginationHTML += generatePageButton(i);
        } else {
            paginationHTML += generatePageButton(1);
            if (currentPage > 3) paginationHTML += generateEllipsis();
            
            let start = Math.max(2, currentPage - 1);
            let end = Math.min(totalPages - 1, currentPage + 1);
            if (currentPage <= 3) end = 4;
            if (currentPage >= totalPages - 2) start = totalPages - 3;

            for (let i = start; i <= end; i++) paginationHTML += generatePageButton(i);
            
            if (currentPage < totalPages - 2) paginationHTML += generateEllipsis();
            paginationHTML += generatePageButton(totalPages);
        }

        // Next Button
        paginationHTML += `
            <button 
                onclick="changePage(${currentPage + 1})" 
                class="px-3 py-1 border rounded-md ${currentPage === totalPages ? 'text-gray-400 cursor-not-allowed bg-gray-50' : 'text-blue-600 hover:bg-blue-50 bg-white'}"
                ${currentPage === totalPages ? 'disabled' : ''}>
                &raquo;
            </button>
        `;

        paginationContainer.innerHTML = paginationHTML;
    }

    function changePage(newPage) {
        const totalPages = Math.ceil(currentSearchResults.length / itemsPerPage);
        if (newPage < 1 || newPage > totalPages) return;
        currentPage = newPage;
        renderPage();
        renderPaginationControls();
        const listTop = document.getElementById('module-results-list');
        if (listTop) listTop.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
</script>
{% endblock %}