{% extends "base.html" %}

{% block title %}Dashboard - UCMS{% endblock %}

{% block content %}
<div id="status-message-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 my-4">
</div>
<!-- Popup Modal -->
<div id="enroll-popup-overlay"
    class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div id="enroll-popup" class="bg-white rounded-lg shadow-lg max-w-md w-full p-6">
        <h3 id="enroll-popup-title" class="text-lg font-semibold mb-2 text-red-600">
            Error
        </h3>
        <p id="enroll-popup-message" class="text-sm text-gray-700 mb-4">
            <!-- message goes here -->
        </p>
        <div class="text-right">
            <button type="button" class="btn-secondary px-4 py-2" onclick="closeEnrollPopup()">
                Close
            </button>
        </div>
    </div>
</div>

<div class="max-w-7xl flex-grow mx-auto" id="dashboard-content">
    <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-900 mb-2">Student Dashboard</h2>
        <p class="text-xl text-blue-600" id="welcome-message">Welcome back, loading...</p>
    </div>

    <!-- === Student Metrics Cards === -->
    <div class="grid md:grid-cols-3 gap-6 mb-6">

        <!-- Current GPA (still hardcoded or later dynamic) -->
        <div class="card p-8 text-center">
            <p class="text-sm text-gray-600">Current GPA</p>
            <p class="text-3xl font-bold text-gray-900" id="metric-gpa">3.85</p>
        </div>

        <!-- Enrolled Courses -->
        <div class="card p-8 text-center">
            <p class="text-sm text-gray-600">Current Enrollments</p>
            <p class="text-3xl font-bold text-gray-900" id="metric-enrolled-count">5</p>
        </div>

        <!-- Completed Courses -->
        <div class="card p-8 text-center">
            <p class="text-sm text-gray-600">Completed Courses</p>
            <p class="text-3xl font-bold text-gray-900" id="metric-completed-count">7</p>
        </div>

    </div>
    <!-- === End Metrics Cards === -->

    <div id="student-info-section" class="grid md:grid-cols-2 gap-6 mb-8">
        <!-- Left: Enrolled -->
        <div class="card bg-yellow-50">
            <h3 class="text-xl font-semibold m-3">Current Enrollments</h3>
            <div id="enrolled-list" class="space-y-2 text-sm">Loading...</div>
        </div>

        <!-- Right: Completed -->
        <div class="card bg-green-50">
            <h3 class="text-xl font-semibold m-3">Completed Courses</h3>
            <div id="completed-list" class="space-y-2 text-sm">Loading...</div>
        </div>
    </div>

    <div class="card mb-8">
        <h3 class="text-xl font-semibold m-3 ">Search Courses</h3>
        <form id="course-search-form" class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
            <input type="text" id="search-query" placeholder="e.g., Core classes, Alan Turing, CS101"
                class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500"
                required>
            <button type="submit" class="btn-primary flex-shrink-0 p-3">Search</button>
        </form>
    </div>

    <div id="scroll-to-view" class="card">
        <h3 class="text-2xl font-semibold mb-4 border-b pb-2">Available Courses</h3>
        <div id="course-results-list" class="divide-y divide-gray-200">
            <p class="text-center text-gray-500 p-6">Use the search bar above to find courses, or click "Show All" to
                browse.</p>
            <button class="btn-secondary w-full mt-4" onclick="handleShowAllCourses()">Show All Courses</button>
        </div>
    </div>
</div>

<script>
    function showEnrollPopup(message, type = 'error') {
        const overlay = document.getElementById('enroll-popup-overlay');
        const titleEl = document.getElementById('enroll-popup-title');
        const msgEl = document.getElementById('enroll-popup-message');

        msgEl.textContent = message || '';

        if (type === 'success') {
            titleEl.textContent = 'Success';
            titleEl.classList.remove('text-red-600');
            titleEl.classList.add('text-green-600');
        } else {
            titleEl.textContent = 'Error';
            titleEl.classList.remove('text-green-600');
            titleEl.classList.add('text-red-600');
        }

        overlay.classList.remove('hidden');
    }

    function closeEnrollPopup() {
        const overlay = document.getElementById('enroll-popup-overlay');
        overlay.classList.add('hidden');
    }

    // --- Store enrollments data globally on this page ---
    let allStudentEnrollments = [];

    document.addEventListener('DOMContentLoaded', () => {
        if (!currentState.loggedIn) { return; }

        document.getElementById('welcome-message').textContent =
            `Welcome back, ${currentState.userName} (ID: ${currentState.studentId})`;

        loadStudentEnrollments();
        document.getElementById('course-search-form').addEventListener('submit', handleCourseSearch);
        handleShowAllCourses();
    });

    async function loadStudentEnrollments() {
        const enrolledList = document.getElementById('enrolled-list');
        const completedList = document.getElementById('completed-list');

        try {
            allStudentEnrollments = await apiFetch(`/api/student/${currentState.studentId}/enrollments`);

            if (!allStudentEnrollments || allStudentEnrollments.length === 0) {
                enrolledList.innerHTML = '<p class="text-gray-500 mx-3">You have no current enrollments.</p>';
                completedList.innerHTML = '<p class="text-gray-500 mx-3">You have no completed courses yet.</p>';

                // Metrics ‚Üí 0
                const enrolledMetric = document.getElementById('metric-enrolled-count');
                const completedMetric = document.getElementById('metric-completed-count');
                if (enrolledMetric) enrolledMetric.textContent = '0';
                if (completedMetric) completedMetric.textContent = '0';
                return;
            }

            const enrolledCourses = allStudentEnrollments.filter(c => c.status === 'Enrolled');
            const completedCourses = allStudentEnrollments.filter(c => c.status === 'Completed');

            // üî¢ Update metric cards based on DB results
            const enrolledMetric = document.getElementById('metric-enrolled-count');
            const completedMetric = document.getElementById('metric-completed-count');
            if (enrolledMetric) enrolledMetric.textContent = enrolledCourses.length;
            if (completedMetric) completedMetric.textContent = completedCourses.length;

            // --- render left column (Current Enrollments) ---
            if (enrolledCourses.length === 0) {
                enrolledList.innerHTML = '<p class="text-gray-500 mx-3">You have no current enrollments.</p>';
            } else {
                enrolledList.innerHTML = enrolledCourses.map(course => `
                <div class="p-2 border border-yellow-200 bg-yellow-100 rounded-md flex items-center justify-between gap-3">
                    <div>
                        <strong class="text-blue-800">
                            ${course.course_id} - ${course.course_name || course.title}
                        </strong>
                        <span class="text-sm block">
                            Taught by: ${course.instructor_name} (${course.credits} Credits)
                        </span>
                        <span class="text-xs font-semibold text-gray-600 bg-gray-200 px-2 py-1 rounded-full">
                            ${course.semester}
                        </span>
                    </div>
                    <button
                        class="inline-flex items-center px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-semibold border border-red-200 hover:bg-red-200 hover:text-red-800 transition"
                        onclick="handleDropEnrollment('${course.course_id}')">
                        Drop
                    </button>
                </div>
            `).join('');
            }

            // --- render right column (Completed Courses) ---
            if (completedCourses.length === 0) {
                completedList.innerHTML = '<p class="text-gray-500 mx-3">You have no completed courses yet.</p>';
            } else {
                completedList.innerHTML = completedCourses.map(course => `
                <div class="p-2 border border-green-200 bg-green-50 rounded-md flex items-center justify-between gap-3">
                    <div>
                        <strong class="text-green-800">
                            ${course.course_id} - ${course.course_name || course.title}
                        </strong>
                        <span class="text-sm block">
                            Taught by: ${course.instructor_name} (${course.credits} Credits)
                        </span>
                        <span class="text-xs font-semibold text-gray-600 bg-gray-200 px-2 py-1 rounded-full">
                            ${course.semester}
                        </span>
                    </div>
                    <div class="text-right">
                        <span class="text-xs text-gray-500 block mb-1">Final Grade</span>
                        <span class="inline-block px-3 py-1 rounded-full bg-green-200 font-semibold text-green-800">
                            ${course.final_grade ?? 'N/A'}
                        </span>
                    </div>
                </div>
            `).join('');
            }

        } catch (error) {
            console.error("Failed to load enrollments:", error);
            enrolledList.innerHTML = '<p class="text-red-500 mx-3">Could not load your enrollments.</p>';
            completedList.innerHTML = '<p class="text-red-500 mx-3">Could not load your enrollments.</p>';
        }
    }

    async function handleDropEnrollment(courseId) {
        const confirmDrop = window.confirm(
            `Are you sure you want to drop course ${courseId}?`
        );
        if (!confirmDrop) return;

        try {
            const data = await apiFetch('/api/enroll/drop', {
                method: 'POST',
                body: {
                    student_id: currentState.studentId,
                    course_id: courseId
                }
            });

            if (data && data.message) {
                // If you‚Äôre using the popup helper:
                if (typeof showEnrollPopup === 'function') {
                    showEnrollPopup(data.message, 'success');
                } else {
                    console.log(data.message);
                }
            }

            // Refresh both enrollments and available courses
            await loadStudentEnrollments();
            await handleShowAllCourses();
        } catch (error) {
            if (typeof showEnrollPopup === 'function') {
                showEnrollPopup(error.message || 'Failed to drop course.', 'error');
            } else {
                console.error('Drop failed:', error);
            }
        }
    }


    async function handleShowAllCourses() {
        try {
            const results = await apiFetch('/api/courses');
            if (results) {
                displayCourseResults(results);
            }
        } catch (error) {
            console.error("Failed to show all courses:", error);
        }
    }

    // --- ‚¨áÔ∏è NEW "SMART HYBRID" SEARCH FUNCTION ‚¨áÔ∏è ---
    // In your <script> block in dashboard.html

    async function handleCourseSearch(event) {
        event.preventDefault();
        const query = document.getElementById('search-query').value.toLowerCase();

        // --- 1. Check for LOCAL context ("my courses") ---
        const localKeywords = ['my', 'enrolled', 'completed', 'my schedule'];
        const isLocalSearch = localKeywords.some(kw => query.includes(kw));

        if (isLocalSearch) {
            // --- LOCAL (SQL) SEARCH ---
            let localQuery = query.replace(/my|courses|in|enrolled|completed|schedule|of/g, '').trim();
            localQuery = localQuery
                .replace(/year (\d)/g, 'y$1')
                .replace(/trimester (\d)/g, 't$1')
                .replace(/tri (\d)/g, 't$1')
                .replace(/\s/g, '');

            const results = allStudentEnrollments.filter(course => {
                const searchCorpus = `${course.course_name.toLowerCase()} ${course.course_id.toLowerCase()} ${course.semester.toLowerCase()}`;
                return searchCorpus.includes(localQuery);
            });

            displayCourseResults(results, true);
        } else {
            // --- GLOBAL (NoSQL) SEARCH ---
            let semanticQuery = query;
            let params = new URLSearchParams();

            // --- Filter 1: Level (Year) ---
            const levelMap = {
                'first year': 1000, 'year 1': 1000, 'year one': 1000, 'y1': 1000, '1000 level': 1000,
                'second year': 2000, 'year 2': 2000, 'year two': 2000, 'y2': 2000, '2000 level': 2000,
                'third year': 3000, 'year 3': 3000, 'year three': 3000, 'y3': 3000, '3000 level': 3000,
            };
            for (const [key, value] of Object.entries(levelMap)) {
                if (query.includes(key)) {
                    params.set('level', value);
                    semanticQuery = semanticQuery.replace(key, '');
                    break;
                }
            }

            // --- Filter 2: Term (Trimester) ---
            const termMap = {
                'trimester 1': 'Fall 2025', 'tri 1': 'Fall 2025', 't1': 'Fall 2025', 'fall': 'Fall 2025',
                'trimester 2': 'Spring 2026', 'tri 2': 'Spring 2026', 't2': 'Spring 2026', 'spring': 'Spring 2026',
                'trimester 3': 'Spring 2026', 'tri 3': 'Spring 2026', 't3': 'Spring 2026'
            };
            for (const [key, value] of Object.entries(termMap)) {
                if (query.includes(key)) {
                    params.set('term', value);
                    semanticQuery = semanticQuery.replace(key, '');
                    break;
                }
            }

            // --- 3. Build and send the API request ---
            semanticQuery = semanticQuery.replace(/courses|course|in|by|for|of/g, '').trim();

            // --- ‚¨áÔ∏è THIS IS THE FIX ‚¨áÔ∏è ---
            // If the query is empty OR the semantic query is empty, just show all courses.
            if (!query.trim() || !semanticQuery.trim()) {
                handleShowAllCourses();
                return; // Stop execution
            }
            // --- ‚¨ÜÔ∏è END OF FIX ‚¨ÜÔ∏è ---

            params.set('q', semanticQuery);

            try {
                const results = await apiFetch(`/api/search?${params.toString()}`);
                if (results) {
                    displayCourseResults(results, false);
                }
            } catch (error) {
                console.error("Search failed:", error);
                // This error will now show the *real* message, e.g. "No query provided"
                showStatusMessage(`Search failed: ${error.message}`, 'error');
            }
        }
        document.getElementById('scroll-to-view').scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
    }
    function displayCourseResults(courses, isLocalSearch = false) {
        const resultsList = document.getElementById('course-results-list');
        if (!resultsList) return;

        let listContent = '';

        if (courses.length === 0) {
            listContent = `<p class="text-center text-red-500 p-6">No courses matched your query.</p>`;
        } else {
            // --- Build a map of the student's current enrollments/completions ---
            const enrollmentStatusById = {};
            (allStudentEnrollments || []).forEach(c => {
                // Treat both Enrolled + Completed as "already taken"
                if (c.course_id && c.status) {
                    enrollmentStatusById[c.course_id] = c.status;
                }
            });

            // --- Sort: available (not enrolled) first, enrolled/completed at bottom ---
            const sortedCourses = [...courses].sort((a, b) => {
                const aEnrolled = !!enrollmentStatusById[a.course_id];
                const bEnrolled = !!enrollmentStatusById[b.course_id];
                if (aEnrolled === bEnrolled) return 0;
                return aEnrolled ? 1 : -1; // enrolled/completed go to bottom
            });

            // --- Render each course ---
            listContent = sortedCourses.map(course => {
                const courseId = course.course_id;
                const courseCode = course.course_code || courseId;
                const courseName = course.course_name || course.title;
                const description = course.description || 'Your enrolled course.';
                const prereqs = course.prerequisites || 'N/A';
                const instructor = course.instructor_name || 'N/A';
                const slotsLeft = course.slots_left ?? 'N/A';
                const maxCap = course.max_capacity || 'N/A';

                const status = enrollmentStatusById[courseId]; // 'Enrolled' / 'Completed' / undefined
                const isAlreadyEnrolled = !!status;

                // --- Button Logic ---
                let buttonHtml = '';
                if (isLocalSearch) {
                    const localStatus = course.status || 'Completed';
                    buttonHtml = `
                    <button 
                        class="btn-secondary ${localStatus === 'Enrolled' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'} cursor-not-allowed" 
                        disabled>
                        ${localStatus}
                    </button>`;
                } else {
                    if (isAlreadyEnrolled) {
                        // Greyed-out status badge (Enrolled / Completed)
                        buttonHtml = `
                        <button 
                            class="btn-secondary bg-gray-200 text-gray-500 cursor-not-allowed" 
                            disabled>
                            ${status}
                        </button>`;
                    } else {
                        const isFull = slotsLeft === 0;
                        buttonHtml = isFull
                            ? `<button class="btn-secondary bg-red-100 text-red-700 cursor-not-allowed" disabled>Full</button>`
                            : `<button class="btn-primary p-3" onclick="handleEnroll('${courseId}', '${courseName}')">Apply</button>`;
                    }
                }

                // --- Grey out the whole row if already taken ---
                const extraClasses = isAlreadyEnrolled ? 'bg-gray-50 opacity-60' : '';

                return `
                <div class="course-item flex justify-between items-center flex-wrap ${extraClasses}">
                    <div class="flex-grow min-w-0 pr-4">
                        <h4 class="text-lg font-bold ${isAlreadyEnrolled ? 'text-gray-600' : 'text-blue-800'}">
                            ${courseName} (${courseCode})
                        </h4>
                        <p class="text-sm ${isAlreadyEnrolled ? 'text-gray-500' : 'text-gray-700'}">${description}</p>
                        <p class="text-xs text-gray-500 mt-1">Prereqs: ${prereqs}</p>
                    </div>
                    <div class="text-right space-y-1 mt-2 sm:mt-0">
                        <p class="text-sm font-semibold ${isAlreadyEnrolled ? 'text-gray-500' : ''}">
                            Taught by: ${instructor}
                        </p>
                        <p class="text-sm ${slotsLeft === 0 ? 'text-red-600' : 'text-green-600'}">
                            ${slotsLeft} / ${maxCap} Slots
                        </p>
                        ${buttonHtml}
                    </div>
                </div>
            `;
            }).join('');
        }

        resultsList.innerHTML = listContent;
        resultsList.innerHTML += `<button class="btn-secondary w-full mt-4 py-2" onclick="handleShowAllCourses()">Show All Courses</button>`;
    }

    async function handleEnroll(courseId, courseTitle) {
        try {
            const data = await apiFetch('/api/enroll', {
                method: 'POST',
                body: {
                    student_id: currentState.studentId,
                    course_id: courseId
                }
            });

            if (data && data.message) {
                // Show success popup (optional)
                showEnrollPopup(data.message, 'success');

                // Refresh UI
                await loadStudentEnrollments();
                await handleShowAllCourses();
            }
        } catch (error) {
            // Show error popup instead of banner
            showEnrollPopup(error.message || 'Enrollment failed.', 'error');
        }
    }

</script>
{% endblock %}