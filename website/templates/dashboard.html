{% extends "base.html" %}

{% block title %}Dashboard - UCMS{% endblock %}

{% block content %}
<div id="status-message-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 my-4">
</div>
<div id="enroll-popup-overlay"
    class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div id="enroll-popup" class="bg-white rounded-lg shadow-lg max-w-md w-full p-6">
        <h3 id="enroll-popup-title" class="text-lg font-semibold mb-2 text-red-600">
            Error
        </h3>
        <p id="enroll-popup-message" class="text-sm text-gray-700 mb-4">
            </p>
        <div class="text-right">
            <button type="button" class="btn-secondary px-4 py-2" onclick="closeEnrollPopup()">
                Close
            </button>
        </div>
    </div>
</div>

<div class="max-w-7xl flex-grow mx-auto" id="dashboard-content">
    <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-900 mb-2">Student Dashboard</h2>
        <p class="text-xl text-blue-600" id="welcome-message">Welcome back, loading...</p>
    </div>

    <div class="grid md:grid-cols-3 gap-6 mb-6">
        <div class="card p-8 text-center">
            <p class="text-sm text-gray-600">Current GPA</p>
            <p class="text-3xl font-bold text-gray-900" id="metric-gpa">3.85</p>
        </div>
        <div class="card p-8 text-center">
            <p class="text-sm text-gray-600">Current Enrollments</p>
            <p class="text-3xl font-bold text-gray-900" id="metric-enrolled-count">0</p>
        </div>
        <div class="card p-8 text-center">
            <p class="text-sm text-gray-600">Completed Courses</p>
            <p class="text-3xl font-bold text-gray-900" id="metric-completed-count">0</p>
        </div>
    </div>

    <div id="student-info-section" class="grid md:grid-cols-2 gap-6 mb-8">
        <div class="card bg-yellow-50">
            <h3 class="text-xl font-semibold m-3">Current Enrollments</h3>
            <div id="enrolled-list" class="space-y-2 text-sm">Loading...</div>
        </div>

        <div class="card bg-green-50">  
            <h3 class="text-xl font-semibold m-3">Completed Courses</h3>
            <div id="completed-list" class="space-y-2 text-sm">Loading...</div>
        </div>
    </div>

    <div class="card mb-8">
        <h3 class="text-xl font-semibold m-3 ">Search Courses</h3>
        <form id="course-search-form" class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
            <input type="text" id="search-query" placeholder="e.g., Core classes, Alan Turing, CS101"
                class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                required>
            <button type="submit" class="btn-primary flex-shrink-0 p-3">Search</button>
        </form>
    </div>

    <div id="pagination-controls" class="mt-3 mb-3 flex justify-center items-center space-x-2 flex-wrap gap-y-2 hidden">
    </div>

    <div id="scroll-to-view" class="card">
        <h3 class="text-2xl font-semibold mb-4 border-b pb-2">Available Courses</h3>
        
        <div id="course-results-list" class="divide-y divide-gray-200 min-h-[200px]">
            <p class="text-center text-gray-500 p-6">Use the search bar above to find courses, or click "Show All" to browse.</p>
            <button class="btn-secondary w-full mt-4" onclick="handleShowAllCourses()">Show All Courses</button>
        </div>
    </div>
</div>

<script>
    // --- 1. POPUP HELPERS ---
    function showEnrollPopup(message, type = 'error') {
        const overlay = document.getElementById('enroll-popup-overlay');
        const titleEl = document.getElementById('enroll-popup-title');
        const msgEl = document.getElementById('enroll-popup-message');

        if (!overlay || !titleEl || !msgEl) {
            console.error("Popup elements not found in DOM.");
            alert(message); 
            return;
        }

        msgEl.textContent = message || '';

        if (type === 'success') {
            titleEl.textContent = 'Success';
            titleEl.className = 'text-lg font-bold text-green-600 mb-2';
        } else {
            titleEl.textContent = 'Error';
            titleEl.className = 'text-lg font-bold text-red-600 mb-2';
        }

        overlay.classList.remove('hidden');
    }

    function closeEnrollPopup() {
        const overlay = document.getElementById('enroll-popup-overlay');
        if (overlay) overlay.classList.add('hidden');
    }

    // --- 2. GLOBAL DATA & STATE ---
    let allStudentEnrollments = [];
    
    // Pagination State
    let currentSearchResults = []; // Holds the full list of courses currently being viewed
    let currentPage = 1;
    const itemsPerPage = 5;
    let isCurrentSearchLocal = false; // Tracks if we are looking at local search results (vs API results)

    // --- 3. INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        if (!currentState.loggedIn) { return; }

        const welcomeEl = document.getElementById('welcome-message');
        if(welcomeEl) welcomeEl.textContent = `Welcome back, ${currentState.userName} (ID: ${currentState.studentId})`;

        loadStudentEnrollments();
        
        const searchForm = document.getElementById('course-search-form');
        if(searchForm) searchForm.addEventListener('submit', handleCourseSearch);
        
        handleShowAllCourses();
    });

    // --- 4. LOAD STUDENT DATA ---
    async function loadStudentEnrollments() {
        const enrolledList = document.getElementById('enrolled-list');
        const completedList = document.getElementById('completed-list');
        
        try {
            allStudentEnrollments = await apiFetch(`/api/student/${currentState.studentId}/enrollments`);

            if (!allStudentEnrollments) allStudentEnrollments = [];

            const enrolledCourses = allStudentEnrollments.filter(c => c.status === 'Enrolled');
            const completedCourses = allStudentEnrollments.filter(c => c.status === 'Completed');

            // Metrics
            const enrolledMetric = document.getElementById('metric-enrolled-count');
            const completedMetric = document.getElementById('metric-completed-count');
            if (enrolledMetric) enrolledMetric.textContent = enrolledCourses.length;
            if (completedMetric) completedMetric.textContent = completedCourses.length;

            // Render Enrolled
            if (enrolledCourses.length === 0) {
                enrolledList.innerHTML = '<p class="text-gray-500 mx-3">You have no current enrollments.</p>';
            } else {
                enrolledList.innerHTML = enrolledCourses.map(course => `
                <div class="p-3 border border-yellow-200 bg-yellow-50 rounded-md flex items-center justify-between gap-3 shadow-sm">
                    <div>
                        <strong class="text-blue-800 block">
                            ${course.course_id} - ${course.course_name || course.title}
                        </strong>
                        <span class="text-sm text-gray-600 block">
                            Taught by: ${course.instructor_name} (${course.credits} Credits)
                        </span>
                        <span class="text-xs font-semibold text-gray-700 bg-gray-200 px-2 py-1 rounded-full mt-1 inline-block">
                            ${course.academic_term}
                        </span>
                    </div>
                    <button
                        class="inline-flex items-center px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-semibold border border-red-200 hover:bg-red-200 hover:text-red-800 transition"
                        onclick="handleDropEnrollment('${course.course_id}')">
                        Drop
                    </button>
                </div>
                `).join('');
            }

            // Render Completed
            if (completedCourses.length === 0) {
                completedList.innerHTML = '<p class="text-gray-500 mx-3">You have no completed courses yet.</p>';
            } else {
                completedList.innerHTML = completedCourses.map(course => `
                <div class="p-3 border border-green-200 bg-green-50 rounded-md flex items-center justify-between gap-3 shadow-sm">
                    <div>
                        <strong class="text-green-800 block">
                            ${course.course_id} - ${course.course_name || course.title}
                        </strong>
                        <span class="text-sm text-gray-600 block">
                            Taught by: ${course.instructor_name} (${course.credits} Credits)
                        </span>
                        <span class="text-xs font-semibold text-gray-700 bg-gray-200 px-2 py-1 rounded-full mt-1 inline-block">
                            ${course.academic_term}
                        </span>
                    </div>
                    <div class="text-right">
                        <span class="text-xs text-gray-500 block mb-1">Grade</span>
                        <span class="inline-block px-3 py-1 rounded-full bg-green-200 font-bold text-green-800 text-sm">
                            ${course.final_grade ?? 'N/A'}
                        </span>
                    </div>
                </div>
                `).join('');
            }

        } catch (error) {
            console.error("Failed to load enrollments:", error);
            enrolledList.innerHTML = '<p class="text-red-500 mx-3">Error loading enrollments.</p>';
        }
    }

    // --- 5. ENROLL / DROP ACTIONS ---
    async function handleEnroll(courseId, courseTitle) {
        try {
            const data = await apiFetch('/api/enroll', {
                method: 'POST',
                body: { 
                    student_id: currentState.studentId,
                    course_id: courseId 
                }
            });

            if (data && data.message) {
                showEnrollPopup(data.message, 'success');
                await loadStudentEnrollments();
                await handleShowAllCourses(); // Refresh available list
            }
        } catch (error) {
            showEnrollPopup(error.message || 'Enrollment failed.', 'error');
        }
    }

    async function handleDropEnrollment(courseId) {
        if (!confirm(`Are you sure you want to drop course ${courseId}?`)) return;

        try {
            const data = await apiFetch('/api/enroll/drop', {
                method: 'POST',
                body: { 
                    student_id: currentState.studentId,
                    course_id: courseId
                }
            });

            if (data && data.message) {
                showEnrollPopup(data.message, 'success');
                await loadStudentEnrollments();
                await handleShowAllCourses(); // Refresh available list
            }
        } catch (error) {
            showEnrollPopup(error.message || 'Failed to drop course.', 'error');
        }
    }

    // --- 6. SEARCH & DATA FETCHING LOGIC ---
    async function handleShowAllCourses() {
        try {
            const results = await apiFetch('/api/courses');
            if (results) {
                // Reset search box visually
                document.getElementById('search-query').value = '';
                displayCourseResults(results);
            }
        } catch (error) {
            console.error("Failed to show all courses:", error);
        }
    }

    async function handleCourseSearch(event) {
        event.preventDefault();
        const query = document.getElementById('search-query').value.toLowerCase();

        // 1. Check for LOCAL context
        const localKeywords = ['my', 'enrolled', 'completed', 'my schedule'];
        const isLocalSearch = localKeywords.some(kw => query.includes(kw));

        if (isLocalSearch) {
            // LOCAL (SQL) SEARCH
            let localQuery = query.replace(/my|courses|in|enrolled|completed|schedule|of/g, '').trim();
            // Map common terms
            localQuery = localQuery
                .replace(/year (\d)/g, 'y$1')
                .replace(/trimester (\d)/g, 't$1')
                .replace(/tri (\d)/g, 't$1')
                .replace(/\s/g, ''); 

            const results = allStudentEnrollments.filter(course => {
                const searchCorpus = `${course.course_name.toLowerCase()} ${course.course_id.toLowerCase()} ${course.academic_term.toLowerCase()}`;
                return searchCorpus.includes(localQuery);
            });

            displayCourseResults(results, true); // true = local search
        } else {
            // GLOBAL (NoSQL) SEARCH
            let semanticQuery = query;
            let params = new URLSearchParams();

            // Filter 1: Level
            const levelMap = {
                'first year': 1000, 'year 1': 1000, 'y1': 1000, '1000 level': 1000,
                'second year': 2000, 'year 2': 2000, 'y2': 2000, '2000 level': 2000,
                'third year': 3000, 'year 3': 3000, 'y3': 3000, '3000 level': 3000,
            };
            for (const [key, value] of Object.entries(levelMap)) {
                if (query.includes(key)) {
                    params.set('level', value);
                    semanticQuery = semanticQuery.replace(key, '');
                    break;
                }
            }

            // Filter 2: Term
            const termMap = {
                'trimester 1': 'Fall 2025', 'tri 1': 'Fall 2025', 't1': 'Fall 2025', 'fall': 'Fall 2025',
                'trimester 2': 'Spring 2026', 'tri 2': 'Spring 2026', 't2': 'Spring 2026', 'spring': 'Spring 2026',
            };
            for (const [key, value] of Object.entries(termMap)) {
                if (query.includes(key)) {
                    params.set('term', value);
                    semanticQuery = semanticQuery.replace(key, '');
                    break;
                }
            }

            semanticQuery = semanticQuery.replace(/courses|course|in|by|for|of/g, '').trim();

            if (!query.trim() || !semanticQuery.trim()) {
                handleShowAllCourses();
                return;
            }

            params.set('q', semanticQuery);

            try {
                const results = await apiFetch(`/api/search?${params.toString()}`);
                if (results) {
                    displayCourseResults(results, false);
                }
            } catch (error) {
                console.error("Search failed:", error);
                showEnrollPopup(`Search failed: ${error.message}`, 'error');
            }
        }
        
        // Scroll to results
        const scrollToView = document.getElementById('scroll-to-view');
        if(scrollToView) scrollToView.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // --- 7. PAGINATION & RENDERING LOGIC ---

    // Phase 1: Process Data (Sort and Save)
    function displayCourseResults(courses, isLocal = false) {
        const resultsList = document.getElementById('course-results-list');
        if (!resultsList) return;

        if (courses.length === 0) {
            resultsList.innerHTML = `<p class="text-center text-red-500 p-6">No courses matched your query.</p>`;
            resultsList.innerHTML += `<button class="btn-secondary w-full mt-4 py-2" onclick="handleShowAllCourses()">Show All Courses</button>`;
            document.getElementById('pagination-controls').classList.add('hidden');
            return;
        }

        // Create enrollment map for lookup
        const enrollmentStatusById = {};
        allStudentEnrollments.forEach(c => {
            if (c.course_id) enrollmentStatusById[c.course_id] = c.status;
        });

        // Sort: Available first (Unenrolled -> Enrolled)
        const sortedCourses = [...courses].sort((a, b) => {
            const aEnrolled = !!enrollmentStatusById[a.course_id];
            const bEnrolled = !!enrollmentStatusById[b.course_id];
            if (aEnrolled === bEnrolled) return 0;
            return aEnrolled ? 1 : -1;
        });

        // Update Global State
        currentSearchResults = sortedCourses;
        isCurrentSearchLocal = isLocal;
        currentPage = 1; // Reset to page 1 on new data

        // Trigger Render
        renderPage();
        renderPaginationControls();
    }

    // Phase 2: Render Specific Page
    function renderPage() {
        const resultsList = document.getElementById('course-results-list');
        
        // Calculate Slice
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedItems = currentSearchResults.slice(startIndex, endIndex);

        // Enrollment map needed again for button logic
        const enrollmentStatusById = {};
        allStudentEnrollments.forEach(c => {
            if (c.course_id) enrollmentStatusById[c.course_id] = c.status;
        });

        const listContent = paginatedItems.map(course => {
            const courseId = course.course_id;
            const courseCode = course.course_id || courseId;
            const courseName = course.course_name || course.title;
            const description = course.description || 'No description available.';
            const prereqs = course.prerequisites || 'N/A';
            const instructor = course.instructor_name || 'N/A';
            const slotsLeft = course.slots_left ?? 'N/A';
            const maxCap = course.max_capacity || 'N/A';

            const status = enrollmentStatusById[courseId];
            const isAlreadyEnrolled = !!status;

            // Button Logic
            let buttonHtml = '';
            if (isCurrentSearchLocal) {
                const localStatus = course.status || 'Completed';
                const colorClass = (localStatus === 'Enrolled') ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700';
                buttonHtml = `<button class="btn-secondary ${colorClass} cursor-not-allowed" disabled>${localStatus}</button>`;
            } else {
                if (isAlreadyEnrolled) {
                    buttonHtml = `<button class="btn-secondary bg-gray-200 text-gray-500 cursor-not-allowed" disabled>${status}</button>`;
                } else {
                    const isFull = slotsLeft === 0;
                    buttonHtml = isFull 
                        ? `<button class="btn-secondary bg-red-100 text-red-700 cursor-not-allowed" disabled>Full</button>`
                        : `<button class="btn-primary p-3" onclick="handleEnroll('${courseId}', '${courseName}')">Apply</button>`;
                }
            }

            const rowOpacity = isAlreadyEnrolled ? 'opacity-60 bg-gray-50' : 'bg-white';

            return `
                <div class="course-item flex justify-between items-center flex-wrap p-4 hover:bg-gray-50 transition ${rowOpacity}">
                    <div class="flex-grow min-w-0 pr-4">
                        <h4 class="text-lg font-bold text-blue-800">${courseName} (${courseCode})</h4>
                        <p class="text-sm text-gray-700 mt-1">${description}</p>
                        <p class="text-xs text-gray-500 mt-1">Prereqs: ${prereqs}</p>
                    </div>
                    <div class="text-right space-y-1 mt-2 sm:mt-0 min-w-[140px]">
                        <p class="text-sm font-semibold text-gray-800">Taught by: ${instructor}</p>
                        <p class="text-sm ${slotsLeft === 0 ? 'text-red-600 font-bold' : 'text-green-600'}">
                            ${slotsLeft} / ${maxCap} Slots
                        </p>
                        <div class="mt-2">
                            ${buttonHtml}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        resultsList.innerHTML = listContent;
    }

    // Phase 3: Render Pagination Controls
    function renderPaginationControls() {
        const paginationContainer = document.getElementById('pagination-controls');
        const totalPages = Math.ceil(currentSearchResults.length / itemsPerPage);

        if (totalPages <= 1) {
            paginationContainer.classList.add('hidden');
            return;
        } else {
            paginationContainer.classList.remove('hidden');
        }

        let paginationHTML = '';

        // --- Previous Button ---
        paginationHTML += `
            <button 
                onclick="changePage(${currentPage - 1})" 
                class="px-3 py-1 border rounded-md ${currentPage === 1 ? 'text-gray-400 cursor-not-allowed bg-gray-50' : 'text-blue-600 hover:bg-blue-50 bg-white'}"
                ${currentPage === 1 ? 'disabled' : ''}>
                &laquo;
            </button>
        `;

        // --- Smart Page Numbers Logic ---
        const generatePageButton = (page) => `
            <button 
                onclick="changePage(${page})" 
                class="px-3 py-1 border rounded-md ${page === currentPage ? 'bg-blue-600 text-white border-blue-600' : 'text-gray-700 hover:bg-gray-100 bg-white'}">
                ${page}
            </button>
        `;

        const generateEllipsis = () => `
            <span class="px-2 text-gray-400">...</span>
        `;

        // Logic to determine which numbers to show
        if (totalPages <= 7) {
            // If 7 or fewer pages, show them all
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += generatePageButton(i);
            }
        } else {
            // If many pages, show: First ... Neighbors ... Last
            
            // 1. Always show First Page
            paginationHTML += generatePageButton(1);

            // 2. Handle Start Ellipsis
            if (currentPage > 3) {
                paginationHTML += generateEllipsis();
            }

            // 3. Middle Neighbors (Current - 1, Current, Current + 1)
            // We clamp the values so we don't repeat 1 or Total
            let startPage = Math.max(2, currentPage - 1);
            let endPage = Math.min(totalPages - 1, currentPage + 1);

            // Edge case adjustments for near-start or near-end
            if (currentPage <= 3) {
                endPage = 4; // Show 1, 2, 3, 4 ...
            }
            if (currentPage >= totalPages - 2) {
                startPage = totalPages - 3; // Show ... 22, 23, 24, 25
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += generatePageButton(i);
            }

            // 4. Handle End Ellipsis
            if (currentPage < totalPages - 2) {
                paginationHTML += generateEllipsis();
            }

            // 5. Always show Last Page
            paginationHTML += generatePageButton(totalPages);
        }

        // --- Next Button ---
        paginationHTML += `
            <button 
                onclick="changePage(${currentPage + 1})" 
                class="px-3 py-1 border rounded-md ${currentPage === totalPages ? 'text-gray-400 cursor-not-allowed bg-gray-50' : 'text-blue-600 hover:bg-blue-50 bg-white'}"
                ${currentPage === totalPages ? 'disabled' : ''}>
                &raquo;
            </button>
        `;

        paginationContainer.innerHTML = paginationHTML;
    }

    function changePage(newPage) {
        const totalPages = Math.ceil(currentSearchResults.length / itemsPerPage);
        if (newPage < 1 || newPage > totalPages) return;

        currentPage = newPage;
        renderPage();
        renderPaginationControls();
        
        // Optional: scroll to top of results
        const listTop = document.getElementById('course-results-list');
        if (listTop) listTop.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
</script>
{% endblock %}