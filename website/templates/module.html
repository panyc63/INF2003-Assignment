{% extends "base.html" %}

{% block title %}Modules - Edukate{% endblock %}

{% block content %}

<script>
    // global vars
    let allModulesData = [];
    let moduleNames = [];
    let currentPage = 1;
    const itemsPerPage = 6;

    // button click handler
    function selectModuleFromButton() {
        const input = document.getElementById('search-input');
        if (moduleNames.length > 0) {
            input.value = moduleNames[0];
            handleSearch();
        }
    }

    // autocomplete selection
    function selectModule(event, moduleName) {
        event.preventDefault();
        const input = document.getElementById('search-input');
        input.value = moduleName;
        handleSearch();
        closeAutocomplete();
    }

    // load dropdown data
    async function populateModuleDropdown() {
        const dropdownMenu = document.getElementById('module-dropdown-menu');
        try {
            const modules = await apiFetch('/api/modules');

            if (modules && modules.length > 0) {
                moduleNames = modules.map(m => m.module_name);
                dropdownMenu.innerHTML = modules.map(module => {
                    const safeName = module.module_name.replace(/'/g, "\\'");
                    return `<a class="dropdown-item" href="#" onclick="selectModule(event, '${safeName}')">${module.module_name}</a>`;
                }).join('');
            } else {
                dropdownMenu.innerHTML = `<p class="dropdown-item text-muted">No modules found.</p>`;
            }
        } catch (error) {
            console.error("dropdown error:", error);
            dropdownMenu.innerHTML = `<p class="dropdown-item text-danger">Error loading modules.</p>`;
        }
    }

    // load initial data
    async function loadAllModules() {
        try {
            const modules = await apiFetch('/api/modules');
            allModulesData = modules;
            currentPage = 1;
            updateView();
        } catch (error) {
            console.error("load error:", error);
            const container = document.getElementById('module-list-container');
            container.innerHTML = '<p class="col-12 text-center text-danger">Error loading modules.</p>';
        }
    }

    // search logic
    async function handleSearch() {
        const searchInput = document.getElementById('search-input');
        const query = searchInput.value;

        if (!query) {
            loadAllModules();
            return;
        }

        try {
            const results = await apiFetch(`/api/search?q=${query}`);
            allModulesData = results;
            currentPage = 1;
            updateView();
            document.getElementById('module-list-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
        } catch (error) {
            console.error(error);
            document.getElementById('module-list-container').innerHTML =
                '<p class="col-12 text-center text-danger">Search failed.</p>';
            document.getElementById('pagination-controls').innerHTML = '';
        }
    }

    // slice data for current page
    function updateView() {
        const container = document.getElementById('module-list-container');

        if (!allModulesData || allModulesData.length === 0) {
            container.innerHTML = '<p class="col-12 text-center h4 text-muted">No modules found.</p>';
            renderPaginationControls(0);
            return;
        }

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedItems = allModulesData.slice(start, end);

        renderModules(paginatedItems);
        renderPaginationControls(Math.ceil(allModulesData.length / itemsPerPage));
    }

    // render cards
    function renderModules(modules) {
        const container = document.getElementById('module-list-container');
        container.innerHTML = '';

        let imgIndex = 1;
        modules.forEach(module => {
            const moduleId = module.module_id;
            const moduleName = module.module_name || module.title;
            const instructor = module.instructor_name || 'TBA';
            const rating = module.score ? (module.score * 5).toFixed(1) : '4.5';
            const ratingCount = module.score ? '(Search)' : '(250)';

            const currentImg = imgIndex;
            imgIndex = (imgIndex % 6) + 1;

            container.innerHTML += `
        <div class="col-lg-4 col-md-6 pb-4">
            <a class="modules-list-item position-relative d-block overflow-hidden mb-2" 
               href="${'{{ url_for("views.module_detail", module_id="TEMP") }}'.replace('TEMP', moduleId)}">
                
                <img class="img-fluid" src="{{ url_for('static', filename='img/modules-') }}${currentImg}.jpg">
                
                <div class="modules-text">
                    <h4 class="text-center text-white px-3">${moduleId} ${moduleName}</h4>
                    <div class="border-top w-100 mt-3">
                        <div class="d-flex justify-content-between p-4">
                            <span class="text-white"><i class="fa fa-user mr-2"></i>${instructor}</span>
                            <span class="text-white"><i class="fa fa-star mr-2"></i>${rating}
                                <small>${ratingCount}</small>
                            </span>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        `;
        });
    }

    // --- DASHBOARD PAGINATION THEME & LOGIC ---
    function renderPaginationControls(totalPages) {
        const controls = document.getElementById('pagination-controls');

        if (totalPages <= 1) {
            controls.style.display = 'none';
            return;
        } else {
            controls.style.display = 'flex';
        }

        // styles to match dashboard theme without tailwind classes
        const btnBase = "padding: 6px 12px; margin: 0 4px; border: 1px solid #dee2e6; border-radius: 6px; cursor: pointer; transition: all 0.2s;";
        const btnInactive = btnBase + "background-color: white; color: #4a5568;";
        const btnActive = btnBase + "background-color: #3182ce; color: white; border-color: #3182ce;";
        const btnNav = btnBase + "background-color: white; color: #3182ce;";
        const btnDisabled = btnBase + "background-color: #f7fafc; color: #a0aec0; cursor: not-allowed;";

        let html = '';

        // Prev Button
        const prevDisabled = currentPage === 1;
        html += `
            <button 
                onclick="changePage(-1)" 
                style="${prevDisabled ? btnDisabled : btnNav}"
                ${prevDisabled ? 'disabled' : ''}>
                &laquo;
            </button>
        `;

        // helper for number buttons
        const generatePageButton = (page) => `
            <button 
                onclick="goToPage(${page})" 
                style="${page === currentPage ? btnActive : btnInactive}">
                ${page}
            </button>
        `;

        // helper for dots
        const generateEllipsis = () => `<span style="padding: 6px 8px; color: #a0aec0;">...</span>`;

        // logic from dashboard
        if (totalPages <= 7) {
            for (let i = 1; i <= totalPages; i++) html += generatePageButton(i);
        } else {
            html += generatePageButton(1);
            if (currentPage > 3) html += generateEllipsis();

            let start = Math.max(2, currentPage - 1);
            let end = Math.min(totalPages - 1, currentPage + 1);
            if (currentPage <= 3) end = 4;
            if (currentPage >= totalPages - 2) start = totalPages - 3;

            for (let i = start; i <= end; i++) html += generatePageButton(i);

            if (currentPage < totalPages - 2) html += generateEllipsis();
            html += generatePageButton(totalPages);
        }

        // Next Button
        const nextDisabled = currentPage === totalPages;
        html += `
            <button 
                onclick="changePage(1)" 
                style="${nextDisabled ? btnDisabled : btnNav}"
                ${nextDisabled ? 'disabled' : ''}>
                &raquo;
            </button>
        `;

        controls.innerHTML = html;
    }

    function changePage(direction) {
        const totalPages = Math.ceil(allModulesData.length / itemsPerPage);
        const newPage = currentPage + direction;

        if (newPage > 0 && newPage <= totalPages) {
            currentPage = newPage;
            updateView();
            document.getElementById('module-list-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    function goToPage(pageNum) {
        currentPage = pageNum;
        updateView();
        document.getElementById('module-list-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // autocomplete ui
    function setupAutocomplete() {
        const input = document.getElementById('search-input');
        const list = document.getElementById('autocomplete-list');

        input.addEventListener('input', () => {
            list.innerHTML = '';
            
            if (allModulesData.length == 0) {
                const modules_not_loaded = document.createElement('p');
                modules_not_loaded.innerText = "Modules not loaded. Try again later."
                modules_not_loaded.classList.add('text-danger');
                modules_not_loaded.classList.add('ms-6', 'me-6', 'mt-1', 'mb-1');
                list.appendChild(modules_not_loaded);
                list.classList.add('show');
                return;
            }

            const value = input.value.toLowerCase();
            
            if (!value) {
                list.classList.remove('show');
                return;
            }

            const matches = moduleNames.filter(name => name.toLowerCase().includes(value)).slice(0, 5);
            if (matches.length == 0) {
                const no_modules_text = document.createElement('p');
                no_modules_text.innerText = "No modules match your query";
                no_modules_text.classList.add('text-danger');
                no_modules_text.classList.add('ms-6', 'me-6', 'mt-1', 'mb-1');
                list.appendChild(no_modules_text);
                list.classList.add('show');
                return;
            }

            matches.forEach(name => {
                const a = document.createElement('a');
                a.className = 'dropdown-item';
                a.href = '#';
                a.textContent = name;
                a.addEventListener('click', e => selectModule(e, name));
                list.appendChild(a);
            });

            list.classList.add('show');
        });

        document.addEventListener('click', (e) => {
            if (e.target !== input) closeAutocomplete();
        });
    }

    function closeAutocomplete() {
        const list = document.getElementById('autocomplete-list');
        list.innerHTML = '';
        list.classList.remove('show');
    }

    // setup listeners
    document.addEventListener('DOMContentLoaded', (event) => {
        populateModuleDropdown();
        loadAllModules();
        setupAutocomplete();

        document.getElementById('search-button').addEventListener('click', handleSearch);
        document.getElementById('module-button').addEventListener('click', selectModuleFromButton);

        document.getElementById('search-input').addEventListener('keydown', e => {
            if (e.key === 'Enter' && e.target.value.trim() !== '') handleSearch();
        });
    });
</script>

<div class="jumbotron jumbotron-fluid page-header position-relative overlay-bottom" style="margin-bottom: 90px;">
    <div class="container text-center py-5">
        <h1 class="text-white display-1">Modules</h1>
        <div class="d-inline-flex text-white mb-5">
            <p class="m-0 text-uppercase"><a class="text-white" href="{{ url_for('views.home') }}">home</a></p>
            <i class="fa fa-angle-double-right pt-1 px-3"></i>
            <p class="m-0 text-uppercase">Modules</p>
        </div>

        <div class="mx-auto mb-5" style="width: 100%; max-width: 600px;">
            <div class="input-group">
                <div class="input-group-prepend dropdown">
                    <button class="btn btn-outline-light bg-white text-body dropdown-toggle" type="button"
                        id="module-button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Modules
                    </button>
                    <div class="dropdown-menu" id="module-dropdown-menu">
                        <a class="dropdown-item" href="#">Loading...</a>
                    </div>
                </div>
                <input type="text" id="search-input" class="form-control border-light" placeholder="Search modules...">
                <div id="autocomplete-list" class="dropdown-menu w-100"></div>

                <div class="input-group-append">
                    <button class="btn btn-secondary" id="search-button">Search</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid py-5">
    <div class="container py-5">
        <div class="row mx-0 justify-content-center">
            <div class="col-lg-8">
                <div class="section-title text-center position-relative mb-5">
                    <h6 class="d-inline-block position-relative text-secondary text-uppercase pb-2">Our Modules</h6>
                    <h1 class="display-4">All Available Modules</h1>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12 d-flex justify-content-center align-items-center flex-wrap" id="pagination-controls">
            </div>
        </div>
        <div class="row mt-5" id="module-list-container">
            <div class="col-12 text-center">
                <div class="spinner-border text-secondary" style="width: 3rem; height: 3rem;" role="status">
                    <span class="sr-only">Loading modules...</span>
                </div>
            </div>
        </div>


    </div>
</div>

{% endblock %}