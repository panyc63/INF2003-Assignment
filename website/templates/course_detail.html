{% extends "base.html" %}

{% block title %}Course Details - Edukate{% endblock %}

{% block content %}
<div id="course-data" data-course-id="{{ course_id }}"></div>
<div class="jumbotron jumbotron-fluid page-header position-relative overlay-bottom" style="margin-bottom: 90px;">
    <div class="container text-center py-5">
        <h1 class="text-white display-1" id="course-header-code">Loading...</h1>
        <div class="d-inline-flex text-white mb-5">
            <p class="m-0 text-uppercase"><a class="text-white" href="{{ url_for('views.home') }}">Home</a></p>
            <i class="fa fa-angle-double-right pt-1 px-3"></i>
            <p class="m-0 text-uppercase"><a class="text-white" href="{{ url_for('views.courses') }}">Courses</a></p>
            <i class="fa fa-angle-double-right pt-1 px-3"></i>
            <p class="m-0 text-uppercase" id="breadcrumb-title">...</p>
        </div>
    </div>
</div>

<div class="container-fluid py-5">
    <div class="container py-5">
        <div class="row">
            <div class="col-lg-8">
                <div class="mb-5">
                    <img class="img-fluid rounded w-100 mb-4" id="course-image" src="{{ url_for('static', filename='img/courses-1.jpg') }}" alt="Course Image">
                    
                    <h1 class="mb-3" id="course-title">Loading...</h1>
                    
                    <h2 class="mb-4 h4">Course Description</h2>
                    <p id="course-description">Please wait while we fetch the course information.</p>
                    
                    <h3 class="mb-3 mt-5">Prerequisites</h3>
                    <p id="course-prereqs">...</p>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card border-0 shadow-sm" style="position: sticky; top: 20px;">
                    <div class="card-header bg-white border-0 p-4">
                        <button onclick="handleEnroll()" id="btn-enroll" class="btn btn-secondary btn-block btn-lg py-3" disabled>Loading...</button>
                    </div>
                    
                    <div class="card-body p-4">
                        <h4 class="mb-3">Course Details</h4>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span class="font-weight-bold">Instructor</span>
                                <span id="course-instructor">...</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span class="font-weight-bold">Course Code</span>
                                <span id="course-code">...</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span class="font-weight-bold">Credits</span>
                                <span id="course-credits">...</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span class="font-weight-bold">Term</span>
                                <span id="course-term">...</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span class="font-weight-bold">Capacity</span>
                                <span id="course-capacity">...</span>
                            </li>
                        </ul>
                    </div>

                    <div class="card-footer bg-white border-0 p-4">
                        <h5 class="mb-3">Enrollment Status</h5>
                        <div class="d-flex justify-content-between mb-1">
                            <span>Slots Left</span>
                            <strong id="course-slots-left">...</strong>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-secondary" role="progressbar" id="course-progress-bar"
                                 style="width: 0%;" 
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted" id="course-slots-filled">... of ... slots filled</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Get the course_id safely from Jinja
    let currentCourseData = null;

    document.addEventListener('DOMContentLoaded', () => {
        const dataElement = document.getElementById('course-data');
        const courseId = dataElement ? dataElement.dataset.courseId : null;
        if(courseId) populateCourseData(courseId);
    });

    async function populateCourseData(id) {
        try {
            const course = await apiFetch(`/api/courses/${id}`);
            currentCourseData = course;

            if (!course || course.error) {
                document.getElementById('course-title').innerText = "Course not found.";
                return;
            }

            // --- Update Header & Text ---
            document.title = `${course.course_name} - Edukate`;
            document.getElementById('course-header-code').innerText = course.course_code;
            document.getElementById('breadcrumb-title').innerText = course.course_name;
            document.getElementById('course-title').innerText = course.course_name;
            document.getElementById('course-description').innerText = course.description || "No description available.";
            
            // --- Prerequisites ---
            const prereqs = course.prerequisites;
            document.getElementById('course-prereqs').innerText = (prereqs && prereqs !== 'None') 
                ? `Requires: ${prereqs}`
                : "No prerequisites required.";

            // --- Sidebar Details ---
            document.getElementById('course-instructor').innerText = course.instructor_name;
            document.getElementById('course-code').innerText = course.course_code;
            document.getElementById('course-credits').innerText = course.credits;
            document.getElementById('course-term').innerText = course.academic_term;
            document.getElementById('course-capacity').innerText = `${course.max_capacity} Students`;

            // --- Enrollment Stats ---
            const current = course.current_enrollment;
            const max = course.max_capacity;
            const left = course.slots_left;
            
            document.getElementById('course-slots-left').innerText = left;
            document.getElementById('course-slots-filled').innerText = `${current} of ${max} slots filled`;

            // Progress Bar Logic
            const percent = max > 0 ? Math.min((current / max) * 100, 100) : 0;
            const progressBar = document.getElementById('course-progress-bar');
            progressBar.style.width = `${percent}%`;
            
            // Update Button State
            const btn = document.getElementById('btn-enroll');
            if (left <= 0) {
                btn.innerText = "Course Full";
                btn.disabled = true;
                btn.classList.add('btn-danger');
                btn.classList.remove('btn-secondary');
            } else {
                btn.innerText = "Enroll Now";
                btn.disabled = false;
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-secondary');
            }

        } catch (error) {
            console.error("Error:", error);
            document.getElementById('course-title').innerText = "Error loading data.";
        }
    }

    async function handleEnroll() {
        // 1. Auth Check
        if (!currentState.loggedIn) {
            window.location.href = '/login';
            return;
        }
        // 2. Role Check
        if (currentState.userRole !== 'student') {
            alert("Only students can enroll.");
            return;
        }

        if(!confirm(`Confirm enrollment in ${currentCourseData.course_code}?`)) return;

        // 3. API Call
        try {
            const payload = {
                student_id: currentState.studentId,
                course_id: courseId
            };
            // apiFetch handles stringify automatically now
            const response = await apiFetch('/api/enroll', {
                method: 'POST',
                body: payload
            });

            alert(response.message || "Success!");
            populateCourseData(courseId); // Refresh stats
        } catch (error) {
            alert(error.message);
        }
    }
</script>
{% endblock %}