{% extends "base.html" %}

{% block title %}Instructor Dashboard - UCMS{% endblock %}

{% block content %}
    <div class="max-w-7xl flex-grow mx-auto" id="instructor-dashboard-content">
        <div class="mb-6">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Instructor Dashboard</h2>
            <p class="text-xl text-blue-600" id="welcome-message">Welcome back, loading...</p>
            <p class="text-gray-500" id="instructor-info">Department: N/A | Title: N/A</p>
        </div>

        <div class="card">
            <h3 class="text-2xl font-semibold mb-4 border-b pb-2">Your Courses (Fall 2025)</h3>
            <div id="course-list-container" class="divide-y divide-gray-200 space-y-4">
                <p class="text-center text-gray-500 p-6">Loading your teaching schedule...</p>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (!currentState.loggedIn || currentState.userRole !== 'instructor') {
                return;
            }
            
            // Set initial welcome message
            document.getElementById('welcome-message').textContent = 
                `Welcome back, ${currentState.userName}`;
            
            loadInstructorDetails();
            loadInstructorCourses();
        });

        async function loadInstructorDetails() {
            if (!currentState.instructorId) {
                document.getElementById('instructor-info').textContent = "Error: Instructor ID not found.";
                return;
            }

            // We use the User ID for API lookup but populate the Instructor ID from localStorage
            const data = await apiFetch(`/api/instructors/${currentState.userId}`);
            
            if (data) {
                document.getElementById('instructor-info').textContent = 
                    `Department: ${data.department_code || 'N/A'} | Title: ${data.title || 'N/A'}`;
            } else {
                document.getElementById('instructor-info').textContent = "Error loading instructor details.";
            }
        }

        async function loadInstructorCourses() {
            const container = document.getElementById('course-list-container');
            if (!currentState.instructorId) {
                 container.innerHTML = '<p class="text-red-500 p-6">Instructor ID is missing. Cannot load courses.</p>';
                 return;
            }

            const courses = await apiFetch(`/api/instructor/${currentState.instructorId}/courses`);

            if (!courses || courses.length === 0) {
                container.innerHTML = '<p class="text-gray-500 p-6">You are not scheduled to teach any courses this term.</p>';
                return;
            }

            container.innerHTML = courses.map(course => `
                <div class="course-item card bg-blue-50 border border-blue-200" id="course-${course.course_id}">
                    <h4 class="text-xl font-bold text-blue-800 mb-2">
                        ${course.course_code} - ${course.course_name} 
                        <span class="text-sm font-normal text-gray-600">(${course.credits} Credits)</span>
                    </h4>
                    <p class="text-sm mb-3">${course.description}</p>
                    <div class="flex justify-between items-center text-sm mb-3">
                        <span class="font-medium text-gray-700">Enrollment: ${course.current_enrollment} / ${course.max_capacity}</span>
                        <button class="btn-secondary text-sm" onclick="showEnrollments('${course.course_id}', '${course.course_name}')">
                            View Students (${course.current_enrollment})
                        </button>
                    </div>
                    <div id="enrollment-details-${course.course_id}" class="hidden mt-3 p-3 bg-white border rounded-lg">
                        <p>Loading student list...</p>
                    </div>
                </div>
            `).join('');
        }

        async function showEnrollments(courseId, courseTitle) {
            const detailsDiv = document.getElementById(`enrollment-details-${courseId}`);
            const button = detailsDiv.previousElementSibling.querySelector('button');
            
            if (detailsDiv.classList.contains('hidden')) {
                detailsDiv.classList.remove('hidden');
                button.textContent = `Hide Students`;
                detailsDiv.innerHTML = '<p class="text-center text-gray-500">Fetching student data...</p>';

                // API endpoint to fetch students enrolled in this course (New endpoint needed in app.py)
                const students = await apiFetch(`/api/course/${courseId}/students`);
                
                if (!students || students.length === 0) {
                    detailsDiv.innerHTML = `<p class="text-center text-gray-500">No students currently enrolled in ${courseTitle}.</p>`;
                    return;
                }

                detailsDiv.innerHTML = `
                    <h5 class="font-semibold mb-2">Enrolled Students (${students.length}):</h5>
                    <ul class="list-disc list-inside space-y-1 text-sm max-h-40 overflow-y-auto">
                        ${students.map(s => `
                            <li>${s.name} (Major: ${s.major}, ID: ${s.university_id})</li>
                        `).join('')}
                    </ul>
                `;
            } else {
                detailsDiv.classList.add('hidden');
                button.textContent = `View Students (${detailsDiv.previousElementSibling.querySelector('span').textContent.split(': ')[1].split(' /')[0]})`;
            }
        }
    </script>
{% endblock %}