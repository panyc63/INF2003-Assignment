<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}UCMS - University Course Management System{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@500;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet"> 

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">

    <link href="{{ url_for('static', filename='lib/owlcarousel/assets/owl.carousel.min.css') }}" rel="stylesheet">

    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .card { @apply bg-white p-6 rounded-xl shadow-lg transition duration-300 hover:shadow-xl; }
        .btn-primary { @apply px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150; }
        .btn-secondary { @apply px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition duration-150; }
        .nav-link { @apply text-gray-700 hover:text-blue-600 font-medium cursor-pointer transition duration-150; }
        .course-item { @apply border-b border-gray-100 p-4 hover:bg-blue-50 transition duration-150; }
        /* Global State and Message holder for the whole app */
        #status-message-container { min-height: 50px; }
    </style>
    
  <script>
    let currentState = {
        loggedIn: false,
        userId: null,
        userRole: '',
        userName: '', 
        studentId: null, 
        instructorId: null,
    };
    
    function updateNavAndState() {
        const authLinkText = document.getElementById('auth-link-text');
        
        // **CRITICAL: Using the UN-PREFIXED keys your original code uses**
        const userId = localStorage.getItem('user_id');
        const userRole = localStorage.getItem('user_role');
        const userName = localStorage.getItem('user_name'); 
        
        // Also load the role-specific IDs which were missing in the original logic:
        const studentId = localStorage.getItem('student_id');
        const instructorId = localStorage.getItem('instructor_id');

        // Determine Logged-In State
        if (userId && userRole) {
            currentState.loggedIn = true;
            currentState.userId = parseInt(userId);
            currentState.userRole = userRole;
            currentState.userName = userName;
            
            // Populate the role-specific IDs in the global state
            currentState.studentId = studentId ? parseInt(studentId) : null;
            currentState.instructorId = instructorId ? parseInt(instructorId) : null;
            
            if (authLinkText) {
                authLinkText.textContent = `Logout (${currentState.userName} - ${userRole.toUpperCase()})`;
            }
        } else {
            // User not logged in
            currentState.loggedIn = false;
            if (authLinkText) {
                authLinkText.textContent = 'Login';
            }
        }

        // Redirect Logic
        const path = window.location.pathname;
        let intendedDashboard = (currentState.userRole === 'instructor') ? '/instructor_dashboard' : '/dashboard';

        if (currentState.loggedIn && (path === '/' || path === '/login')) {
            window.location.href = intendedDashboard;
        } 
        else if (!currentState.loggedIn && (path === '/dashboard' || path === '/instructor_dashboard')) {
            window.location.href = '/login';
        }
    }

    // --- Logout Function (Made global for HTML onclick) ---
    window.handleAuthClick = function() {
        if (currentState.loggedIn) {
            // Clear ALL relevant keys (including the role-specific ones)
            localStorage.removeItem('user_id');
            localStorage.removeItem('user_role');
            localStorage.removeItem('user_name');
            localStorage.removeItem('student_id');      // Clear role-specific ID
            localStorage.removeItem('instructor_id');   // Clear role-specific ID
            Â 
            showStatusMessage('Logged out successfully.', 'success');
            window.location.href = '/login'; 
        } else {
            window.location.href = '/login';
        }
    }
    
    // Utility functions (keeping them global as they are used by login.html and dashboard.html)
    function showStatusMessage(message, type = 'info') {
        const container = document.getElementById('status-message-container');
        if (!container) return;

        // ... (The implementation of showStatusMessage remains the same)
        const bgColor = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' :
                        type === 'error' ? 'bg-red-100 border-red-400 text-red-700' :
                        'bg-blue-100 border-blue-400 text-blue-700';

        container.innerHTML = `
            <div class="border ${bgColor} px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">${type.toUpperCase()}!</strong>
                <span class="block sm:inline ml-2">${message}</span>
            </div>
        `;
    }

    async function apiFetch(url, method = 'GET', body = null) {
         try {
            const options = {
                method: method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (body) { options.body = JSON.stringify(body); }

            const response = await fetch(url, options);
            const contentType = response.headers.get("content-type");
            
            if (!contentType || !contentType.includes("application/json")) {
                if (response.ok) return { message: 'Action successful' };
                throw new Error(`Server returned status ${response.status}`);
            }

            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || 'An unknown error occurred.');
            }
            return data;

        } catch (error) {
            console.error('API Error:', error);
            showStatusMessage(`${error.message}`, 'error');
            return null;
        }
    }

        // Run the update only after the DOM is loaded
        document.addEventListener('DOMContentLoaded', updateNavAndState);
    </script>
    
    {% block head_extras %}{% endblock %}
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-white shadow-md sticky top-0 z-10">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-800"><a href="/">UCMS</a></h1>
            <div class="flex space-x-6">
                <a href="/" class="nav-link">Home</a>
                <a href="/about" class="nav-link">About Us</a>
                <a href="/course" class="nav-link">Courses</a>
                <a href="/login" class="nav-link" id="auth-link-text" onclick="handleAuthClick()">Login</a>
            </div>
        </nav>
    </header>


    <main class="px-4 sm:px-6 lg:px-8 py-10 w-full">
        {% block content %}{% endblock %}
    </main>
    
    <!-- Footer -->
    <footer class="bg-gray-100 mt-auto">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 text-center text-gray-500 text-sm">
            &copy; 2025 University Course Management System. All rights reserved.
        </div>
    </footer>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='lib/easing/easing.min.js') }}"></script>
    <script src="{{ url_for('static', filename='lib/waypoints/waypoints.min.js') }}"></script>
    <script src="{{ url_for('static', filename='lib/counterup/counterup.min.js') }}"></script>
    <script src="{{ url_for('static', filename='lib/owlcarousel/owl.carousel.min.js') }}"></script>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>


</body>
</html>